shamir secret sharing it's 3 a.m only good things happen at 3am okay my mom told me that when i was younger and i wanted to go out with my friends you know what she said well only good things happen at 3am so you go out kid you go out and you go have fun at 3 a.m nothing bad's gonna happen only good things paul the head of paypal database administration carefully enters his elaborate passphrase at the keyboard in a darkened cubicle of'40 in bacadero road in east palo alto i bet i bet him i i know this place you were born you were born at 3am 100 true for the fifth time he hits enter the green on black console window instantly displays one line of text sorry one or more wrong pass phrases cannot reconstruct the key goodbye so paul obviously a lot like me trying to log into my instagram got a little bit of a boomer moment couldn't get logged in okay totally normal okay sometimes we forget our passwords not a big not a not a big deal by the way this would literally be the most terrifying thing in in the entire universe okay if this happened i have many questions one of them is just being able to just straight up log in with the password this just seems terrifying anyways there's a nerd pandemonium all around us james our recently promoted vp of engineering just climbed the desk at a nearby cubicle screaming god ice if we can't get this key right right away we gotta start brute forcing it asap it's gallows humor wait what he knows very well that brute forcing such a key would take millions of years and it's already 6 a.m on east coast the first of many why is paypal down today articles is undoubtedly going to hit cnet shortly oh my goodness just the pure terror one i mean i've introduced a few bugs at netflix okay like uh late let's say like here's a good one uh lady gaga's billboard for for netflix uh she had a show come out and if you were on the web when the countdown timer had zero i accidentally created an infinite recursion loop and everything frozen broke okay i did that i accidentally did that my fault i'm sorry i'm sorry to everybody i'm sorry to my family i'm sorry i've made repentance before god and and my country it is my fault i did that okay sure all you have to do is refresh the site and everything works but if you were waiting if you were waiting for that exact moment specifically on a chrome browser at midnight pacific coast time the united states of america the only country in the world then guess what you were disappointed you had the refresh and yet here i am still at netflix okay we've all done that hey we have all done that our single story cubicle maze office is buzzing with nervous activity of pay paleoons paypalions i hate that name uh who know they can't help but want to do something anyways i poke my head above the cubicle wall to catch a glimpse of someone trying to stay inside a giant otherwise empty recycling bin on wheels while a couple of senior engineers are attempting to accelerate the bin up to dangerous speeds in the front lobby what the hell is this entire paragraph what i am what i'm hearing described here is that the world's about to explode you apparently hired senior engineers that are also six-year-olds what the hell is happening here i lowered my head and tried to stay focused let's try it again this time with three different people is the best idea i can come up with even though i'm quite sure it will not it will not work who here hasn't done this three people one password prompt okay who hasn't done this who hasn't been the person that's like you know what it hasn't worked yet but maybe we haven't used enough people let's try it again all the paypalions came in senior engineers in shambles in the front they've given up the ghost right they they've gone completely insane just driving recycling bins as if they're vehicles at dangerous speeds within an office you can tell shambles shook and shambles the key in question decrypts paypal's master payment credential table also known as the giant store of credit card and bank account numbers without access to the payment credentials paypal doesn't really have a business per se seeing how we are supposed to facilitate payments and that's really hard to do if we no longer have access to the 100 million credit card numbers our users added over the last year of insane growth i just want to take i just want to take just a quick moment and i want you to think about the idea of being the person that has to tell a higher up that you lost it all like i just want you to feel that i just want you to feel it for a moment how that must just be this is the story of the catastrophic software bug i briefly introduced into the paypal code base that almost cost us the company or so it seemed in the moment oh let's go i've told this story to a handful of times always swearing the listeners to secrecy and surprisingly it does not appear to have ever been written down before 20 plus years since the incident it now appears instructive and a little funny rather than merely extremely embarrassing i you know what i haven't told anybody that it was a lady gaga's billboard until this one that's like eight years later okay i understand it can get very embarrassing when you screw up uh before we got back to the uh fateful night we have to go back to an another decade in the summer of 1991 classic summer by the way my family and i moved to chicago from kiev ukraine uh while we had just a few hundred dollars between the five of us we did have one secret advantage science fiction fans my dad was a highly active member of i don't even know what that is kievs uh possibly first and possibly only at the time sci-fi fan club the name means star trek in ukrainian unsurprisingly he translated uh some uh stancil stancil la lem of solarus futurological congress frame fame from polish to russian in the early 80s and was generally considered the core of i do it okay i don't know what any of these words mean am i outing myself as not actually a nerd at this point or is this just is this just a new level that i am okay not achieving well it's okay we're just seeing it's translated content week yeah i'm weak okay while ussr was more or less informationally isolated behind the digital iron curtain until the late 80s by 1990 or so things like phytonet wriggling wriggled their way into the soviet computing world and some members of zish i'm just gonna call it zish because i don't know zsh that's obviously not this it's not it's not like it's not like oh my zish right here right it's something it's something else okay i don't know i don't know pick pick what is it uh we're now changing electronic mail with sci-fi fans for free world uh of the free world the vaguely exotic news of two soviet refugee sci-fi fans arriving in chicago was transmitted to the local fandom before we had even boarded the pan am flight that took us across the atlantic that is such a cool story that is such a cool story right there my dad and i by extension was soon adopted by some kind of chicago science fiction geeks a few of whom became close friends over the years though that's a story for another time holy cow that is incredible a year or so after the move to chicago our new science our new sci-fi friends invited my dad to a birthday party for a rising star of the local fandom one bruce schneier uh we we certainly did not know bruce or really anyone at the party but it but it promised good food friendly people and probably silk i don't know what filk is is that milk what is phil because that ukrainian milk i don't know my role was to translate as my dad spoke limited english at the time i had fallen desperately in love with secret codes and cryptography about a year before we left ukraine walking into bruce's library during the house tour this was a couple years before applied cryptography was published and he must have been deep in research felt like walking into narnia nice i promptly abandoned my dad defend for himself as far as small talk and kind of this okay i'm not a well-learned man all right this is embarrassing we're concerned uh and proceeded to make i don't know how to say these things when i see an oxidegu i don't know what it means okay that's french for a little thingy on top i don't know i don't know what it means you're doing great shut up pick uh and proceeded to make a complete ass out of myself oh i see there's two of us doing that out of myself by brazingly asking the host for a few sheets of paper and a pencil having been obliged i pulled a half dozen cryptography books from the shelf and went to work trying to copy down on some of the answers to a few long-held questions on the library floor after about two hours of scribbling alone like a ma a man obsessed i ran out of paper and decided to temporarily rejoin the party on the living room table bruce had a stack of copies of his a fanzine ramblings thinking i could use the blank size of the pages to take more notes i grabbed a printout and was about to quietly return to copying the original s-box values for des what a door when my dad spotted me from across the room and demanded i help him socialize the party wrapped soon and our friends drove us home the printout i grabbed was not a ramblings issue it was a short essay by bruce titled sharing secrets among friends essentially a humorous explanation of shamir's secret sharing say you want to say you want to make sure that something really really important in secret a nuclear launch code and database encryption key etc cannot be known or used by a single friendly actor but becomes available if at least n people from the group of m choose to do it okay okay uh think of two on-duty officers a cadre of five say turning keys together to get ready for a nuclear launch okay okay the idea proposed by addie shamir the a of rsa in 1979 and as a simple let's see is as simple as it is beautiful let's call the secret we are trying to split among m people k oh we're about to get hit with math pick should i get you on the phone you do a lot of haskell am i about to like do i need to know haskell to look at this stuff you know i only write o camel which is like toddler functional programming it's toddler functional programming right is this quick math i don't know quick math no haskell needed okay i'll try um first create a totally random polynomial that looks like this classic let's create some polynomials okay start with uh power to the end all the way to x plus cave okay create here just means generate a bunch of random co fish and c1 through cn now for every person in your trusted group of m evaluate the polynomial for some randomly chosen x of m and hand them their corresponding x m y m each classic when you really think of it we have if we have n of these points together you can use the language inter interpolating polynomial to reconstruct the coefficients and evaluate the original polynomial x equals zero which conveniently gives us y equals zero which is k the secret beautiful da da da i still had a printout uh with me years later in palo alto it should come across the no surprise that during my time as cto as cto paypal engineering had an absolute obsession with security no firewall was too many no multi-factor authentication schemes too onerous etc anything that was worth anything at all was encrypted at uh at rest okay to decrypt a service would get the needed data from the database table transmitted to a special service named crypto serve the original sun hardware running solaris sitting on its own especially tightly locked down network okay a and a special service running only there would perform the decryption and send back the result decryption request rate was monitored externally on the crypto serve and if there were too many requests the whole thing was shut down and purged of any sensitive data and the keys from memory until manually restarted okay i i feel like some of those i feel like some of those uh uh crypto services probably could have used maybe some similar security huh mt gox right now seething and coping um all right it was it was this manually restarted that nod me at launch a bunch of configuration files containing various critical decryption keys were read decrypted by another key derived from one manually entered path for passphrase and loaded into memory to perform future cryptographic services four or five of us on the engineering team knew the passphrase and could restart crypto serve if it crashed or simply had to have an upgrade what if someone performed a little old-fashioned rubber host uh crypt analysis and literally beat the passphrase out of one of us that literally could happen right this guy writes well yeah the attacker could theoretically get access to all these important master keys then stealing the encrypted at rest database of all of our users secrets could prove useful they could decrypt them in the comfort of their underground super villain lair i needed to eliminate this threat okay i think we're starting to see where this is going i mean i hopefully you saw hopefully you understood what was happening right here clearly this is what's happening here the guy created the multi-key turn and then effed it all up and almost lost everything is what it sounds like i needed to eliminate this threat shamir's secret sharing was the obvious choice beautiful simple perfect you could in fact prove that if done right it offers perfect secrecy i decided on a three of eight scheme and implemented it in pure posix c for portability over a few days and tested it for several weeks on my linux desktop with other engineers classic shamir moment just classic just shamira on the just shamir on the troubles uh step one generate the polynomial coefficients for eight shareholders compute the keyshards x 0 y 0 through x7 y7 get get each shared shard holder shard holder to enter a long secure passphrase to encrypt the shard right out to the eight shard files encrypt with their respective passphrases and reconstruct pick any three shard files ask each of the respective owners to enter the passphrases decrypt the shard files reconstruct the polynomial evaluated to x equals zero launch the crypto server with keys dude when i read this i think about one thing what happened if six of your eight people are traveling on an airplane together like you could you could act you could ruin your life like this stuff is crazy can't let that happen i don't do it dude it's so crazy you'd actually have to have these people like take separate you'd have to have like backups they would split up there's literally stuff that make sure uh yeah i know there's like there's also key man insurance there's all sorts of stuff like this it's just crazy that's why you do the same thing uh they do during state of the union addresses yeah you have to have people out designated survivors one design detail here is that each shard file is also stored let's say also stored a message authentication code a keyed hash of its pass of its passphrase to make sure we could identify when someone mistypes their passphrase these tests uh ran hundreds and hundreds of times on both linux and solaris to make sure i did not screw up a big little indie in this issue very smart man by the way that is like the most classic way to screw things up it all works perfectly a month or so later the night of the key splitting a party was upon us we are finally going to close out our last vulnerability and be secure feeling as if it was about my turn uh feeling as if i was about to turn my fellow shard holders into cymax again this is a joke i don't understand i gathered them around my desktop as paypal's front page but again sporting the we are down for maintenance and we'll be back soon message around midnight getting excited the night before i solemnly generated the new master keys and securely copied it to crypto serve now while push it by salt and pepper blaird from someone's desktop speakers the automated deployment script copied shard files to their destination while each of us took turns carefully entering our elaborate pass races at the specially selected keyboard paul shut down the main database and decrypted the paypal credentials table then ran the script to re-encrypt the new with the new key some minutes later the database was running smoothly again with the newly encrypted table without incident you think they would have had a backup copy for this one and only thing in this moment cymac are from dune really am i saying it right i only listen to dune i've never read dune out loud so i've only listened to it i must be saying it incorrect or with cymac and book like book three or longer clueless is it book three that they get introduced because i'm almost done with book two the telexu is this duncan idaho the face oh that guy tila oh yeah taylax or whatever his name is dude that guy is a weirdo he only like i only have like a small little little picture of him a really weird guy okay all right he like pokes that guy in the neck and then kills the sun is a a gola that's right he has an angola uh dude we're excited uh apart uh you take us that way hold on you take us on side trips sorry sorry okay my bad my fault okay here let's keep on going all that was left was to restore the master key from its shards and launch the new even more secure crypto service the three of us entered our passphrases to be met with the error message i sh i haven't seen in weeks sorry one or more passphrases or one or more wrong passphrases cannot reconstruct key goodbye his own error message his literally own error message in his own face right there surely don't call me shirley one of us screwed up typing no big deal we'll do it again no dice no dice again and again and even after we tried to numerous combination of three people necessary to decrypt minutes passed confusion grew tensions rose rapidly there was nothing to do except hit rewind to grab the master key from the file uh still sitting on crypto serve split it again generate new shards choose passphrases and get it done not a great feeling to have in our first launch go wrong but not a huge deal either it will be okay in a minute or two a cursory look at the master key file date told me that no it wouldn't be okay at all the file sitting on crypto serve wasn't from last night it was created just a few minutes ago oh no no you overwrote it there was no copies you during the salt and peppa pushed or theme pushed from stage we rewrote the master key file with the staged version whatever key that was it wasn't the one i generated the day before only one copy existed the one i copied to crypto serve from my computer the night before zero copies existed now not only that the push grips appear to have also wiped out the backup of the old key so the database backups we have encrypted with the old key are likely useless kid wrecked i moved to the bahamas after this yeah i'm going straight bahamas sit rep we have eight sharded files that apparently cannot use to restore the master key and zero master key backups the database is running but its secret data cannot be accessed i'll leave it to your imagination to conjure up what was going through my head that night as i stared into the black screen willing the shards to work after half a decade of trying to make something of myself instead of just going to work for microsoft or ibm after graduation i had just destroyed my first successful startup in the most spectacular fashion still the idea of what if we all just continuously screw up our master passphrases swirled around in my brain it was easy to check to perform it was an easy check to perform thanks to include max i added a single print f to bug statement into the shard reconstruction code instead of printing out the summary error of one or more the code now showed if the passphrase entered match the authentication code stored in the shard file oh no oh this is so good i compiled the new code directly into crypto serve or directly on cryptoserv and direct contravention of all reasonable security practices what else did i have to lose entering my own passphrase i got prompted bad passphrase error i just added it to the code well that's just great i knew my passphrase was correct i had written it down on a post-it note i had planned to rip up hours ago another person same error finally the last person jk entered his pass race no error the key still did not reconstruct character uh correctly i got the goodbye but something worked i turned to the engineer and said what did you just type in that worked after a second of embarrassed mumblings he admitted he chose the password ass word [applause] word saved paypal take a moment here and realize that ass word saved paypal oh [music] the guy the gall i asked everyone entrusted with the grave task of relaunching the crypto serve to pick really hard to guess passphrases in this guy still this was something it worked but why i sprinted around dude how much do you want to bet before looking on this is gonna be some sort of stir and buffer length problem how much do you want to bet that only small passwords worked and everyone's password got cut off to a certain length because when they were testing it they all just chose small passwords how much do you want to bet that was it that's my guess that's my guess right now so okay we got some dollars in there okay we got my guess as well i bet you that uh i sprinted around the half-lit office grabbing the rest of the shareholders demanding they tell me their passphrases everyone else had picked much lengthier passwords of uh yes yes i manually tested each one and none decrypted correctly except password what was it a lightning bolt hit me and i sprinted back to my own cubicle the far corner unlocked the screen and typed in man get pass oh yes on the command line while logging in the crypto serve in another window and doing exactly the same thing there i saw exactly what i needed to see today should you try to read up the programmer's manual aka the man page on get pass you'll find has been long declared obsolete and replaced with a more intelligent alternative in nearly all flavors of modern unix back then or but back then if you wanted to collect some information from the the keyboard without printing what was being typed onto the screen and remained posit compliant get pass did the trick because he did a posic posix only c implementation did pass did the trick other than a few standard final manipulation system calls git pass was the only operating uh system service call i used to ensure clean portability between linux and solaris except it wasn't completely clean plain as day there it was the manual pages were identical except stellaris had a special feature any passphase entered that was longer than eight characters was automatically reduced to that length anyways who needs long passwords am i right oh come on s word dude ass work did it oh ask word saved the day no way no way i screamed like a wounded animal we generate the key on my linux desktop and entered our novel length passwords right there attempting to restore them on the solaris machine and they were being clipped down to eight characters long would never work except of course for ass word that one was fine the rest was an exercise in high speed coding and some entirely off-protocol file movement uh moving we reconstructed the master key on my machine and all of our passphrases worked fine copied the file to solaris running crypto serve re-split it there in very short passphrases reconstructed it successfully and paypal was up and running again like nothing ever happened by the time the unsuspecting colleagues rolled back into the office i started to doze on the floor of my cubicle and that was that let's go when someone asked me later that day why it took us so long to bring the site back up i simply responded with eh should have read the [ __ ] manual um rtl rtfm let's go let's go rtfm indeed p.s post scriptum a few hours later john our general counsel stopped by my cubicle to ask me something the day before i apparently gave him a sealed envelope and asked him to store it in his in his safe for 24 hours without explaining myself he wanted to know what to do with it now that 24 hours have passed ha i forgot all about it but in an about of what if this doesn't work paranoia i printed out the base64 encoded master key uh when we generated it the night before stuffed it into an envelope and gave it to john for safe keeping we shredded it together without opening and laughed about what would never actually been a company-ending event what a smart guy dude what a smark i forgot he even had this and it turns out he had a backup printed version post post scriptum if you're thinking all the ways this whole sss i don't know what sss stands for i'm sure there's a great thing design is horribly insecure it had uh some real flaws for sure and planned to poke around paypal to see if it might still be there don't while it serves us for uh well for a few years this was a very first thing ebay required us to turn off after the acquisition pretty sure it's back to single passphrase now notes one a member of the chicago land sci-fi community let me know that the original news of our move to the us was delivered to them via posted letter snail mail not fido net email a hand written letter sent guys this was this was the best article i've ever written in my lifetime or read my lifetime that was is shamir smarter than tom no that was the best article i've ever read my lifetime that was fantastic the link will be in the youtube video of course for any amount of sharing beautiful here's the link now absolutely outrageous the name is the shamira gin look at that okay this is what makes paypal databases drop