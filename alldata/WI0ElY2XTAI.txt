uh okay writing a node library in Rust just recently uh written uh metlow is an open source API security tool you can set up in less than 15 minutes that inventories your endpoints to text Bad actors and blocks malicious traffic in real time there's no way you're setting it up in less than 15 minutes that's like like we should test this fake news I I honestly I don't want to test it because two hours and I'm gonna be too upset to say to stop but also we do this by shipping an agent that integrates with any Tech stack that analyzes and blocks API traffic as it's coming in okay the issue that we uh needed to make our agent support a ton of platforms like nginx node kubernetes go AWS traffic monitoring Etc so either we could reach three dots after an Etc like that shouldn't just be one it actually no to properly do it in an Etc you have to do two Etc etc etc true yeah so normally you just do it twice you don't you don't ellipsey for dramatic pause and Etc nice just throw that out there stop talking about my nods chat okay I'm just I'm I'm an empathetic listener okay I like how we do one video together and people are just like look at TJ nodding along as Prime is wrong about a concept hey at least at least they're dunking on me and not you you're just being a nice guy they're like look how nice TJ is when Prime's such a dummy I'm sitting over that moon but it feels like then all I didn't say anything all I did was just nod the whole time I have no I mean empty head I know look at that empty head you've got a see-through is that a skateboard ramp underneath smart about it I love the spice I love the spice of that statement uh it in came rust with its ability to create C compatible library that could be uh that could then be consumed by various ffi libraries on required language or using low latency communication systems like grpc or pipes nice I'm confused at this whole grpc in low latency uh talk just because grpc is I mean uses HTTP 2 you know well compared to like Json RPC it's probably low latency right well can't you just say you don't know right like are you communicating to the backbone and you're on the backbone or are you communicating crappy internet shooting through Elon satellites bouncing across the world like I don't know what's happening uh here we'll explore how we did this for node.js using rust-based Library called neon I've heard about this neon I've actually been wanting to explore this by the way I work at Netflix did you know that TJ holy cow that seems really cool I bet you get a free Netflix subscription you will shut your mouth and no I don't um anyways uh I I try to self-promote me working at Netflix almost as much as you self-promote the fact that you stream on twitch.tv yeah oh I do stream yeah that's something that you mention it crazy uh yeah so I've actually I'm I'm gonna be investigating neon because I hear that you can you can it's it's actually pretty dang easy so I'm actually I I like this this is kind of exciting this is actually this article has got an except exceptionally more exciting so what is it I'm ready as described by Neon Itself by the way we need to quit calling things neon there is entirely you cannot Search up the word neon uh plus it's like spelled the same as the actual like people do look up real neon things too there's also neon database provider yep there's just too many things called neon uh as described by Neon itself neon is a library and Tool chain for embedding rust into your node.js apps and libraries so essentially neon enables us to run rust code along with and inside our node.js code let's look at a timing example here npmnet neon hello world yeah that's kind of cool I didn't realize you could do that they're just using npm I mean isn't this 2023 why not like discuss the various merits of the different package managers you're right because we should have considered yarn or pnpm both harder to say and spell than npm yeah all right well whatever whatever uh don't worry it's 2023 lots of lots of time left in 2023 we'll have a fourth one soon don't worry I do hope so I think it's gonna be called neon which is crazy neon and it neon neon that's why Neon neon uh or neon install neon uh this sets up an npm package with the starter code for uh for setting up a rust Library here's the build cargo file okay beautiful beautiful blah blah blah blah dependencies got one of those uh the important bits that CD y live part yep the like lib yep that's anything that makes it special and you also need this thing right here so this is actually nodes API that's like Snappy yeah nappy I always called it nappy but it's node API it's kind of like Mouse it's it's not malic it's m Alec I'm glad you beat I'm glad you beat me to the punch on that one I was gonna bring it up again don't want to uh nothing too interesting here but take notice of the crate type is not a standard bin or lib qtj but rather oh C D die lib which must mean c Dynamic Library I think so yeah okay what this means is that rust will create a c compatible Dynamic library in addition there's a dependency already inserted for neon Target the node API version 6 so the module will run fine on node 10.0 and onwards full compatibility Matrix here oh gosh this is a matrix well I'm seeing I'm seeing numbers TJ uh okay where was I do you know where I was we were on six oh which tab we were reading about neon oh it's just the back button sorry I thought I opened it in a new one I'm stupid don't worry about it what about the starter code that got generated Source lib okay this looks good this looks nice okay context string function context oh cool this actually is it's actually looks pretty good that looks pretty good I I'm not I'm not upset about it so we have a function that takes that has the neon main attribute note that the function uh that's attributed as such doesn't necessarily need to have the name main that has one parameter CX which is a type module context this is essentially making an equivalent of node module here and then within the module we can export functions as we would in node project have you ever built a uh node native module oh I don't know I've written I've written stuff that runs on node but I don't know if I've actually had to do the very first step I don't know how anything actually works I just hope that the like npm run build works on whatever JavaScript project I pulled out you know I hope this you know last week I spent over a day trying to get esm to play nicely I I know that that's the word that you've said a lot of times and I just know that I've run into that before and that's usually when I just quit yes somebody else or if we're not using that dependency it's just the worst thing in the universe I'm like I'm I'm not a JavaScript boy you know like I'm gonna I just write this JavaScript for this one thing and then if it doesn't if it doesn't run then is that somebody else's problem I'll just I'll talk to devops I'm gonna build expert okay I'm not a build master as it used to be called yeah uh this is essentially making an equivalent of a node module here and then within that module we can export functions as we would in the node project here we do that with the function hello so this is pretty much identical to how you do a c plus one as well very very similar you kind of say like hey I want to export this function it's named this here's the function Handler this is super common as well like um I've seen this a bunch before for doing it with Lua as well because I've done a bunch of like ffi stuff with Lua and rust yeah looks it looks pretty similar I will say that I hate this convention with a passion that all on the same line both what you're doing plus a return statement if only there was a key word that would describe your intention of your code as opposed to its floating placement within everything all right let's close let's just close the article honestly who puts those on the same line I know that it's this is more offensive than an if statement with no squirrely brace that's true it is it's just like it is the epitome of the most offensive code I've seen in a long time uh anyways okay so let's see uh the hello function itself takes a mutable parameter context of the type function contest that exports a JS result of type JS string in that function we return a result containing hjs string the result automatically gets cast to ajs result also note that JS string is constructed within the context of the parameter CX so the string constructed here is a valid.js string not necessarily a Russ style string so in other words JavaScript needs to be able to have the context of it it needs to be able to store it on a heap it needs to be able to keep track of it that's why you have to that's why I assume you can create a bunch of rust stuff go real fast on the rust stuff and then at the end you create the little contact stuff and then go for you just basically write your whole library and then you just write like 10 wrap or functions I'm guessing that's what they're going to tell us yeah npm run build I I can't no way it works this command generates an artifact by the name of index.node strange uh this contains all the exported rust code and what we'll be using with node to communicate with now that we have the article index.node today bingo card of 2023 has been wild okay this is and this is one of them all right now that we have the artifact build let's add an index.js file which we'll use to test our code all right get this one and then we can go hello by the way not using import statements in 2023 offense well who knows what building thing they're using I still don't know how I still don't know the difference between require and import okay so require is a function that can be used [Music] [Laughter] we can see it outputs this okay nice Little Rock on a more complex example here okay so we can do a bunch of stuff we can do anime Chan response okay I see why they put return values on the same line uh a result Vector animation response request a request error Okay blah blah no one cares get anime quote okay did they really choose this is like this isn't wait this isn't like their official thing for neon or is it their official thing for me no this is the official thing for this article okay but wait it's for a real they chose like all the examples in the world they're like let's make it anime anime Chan an anime quote generator okay all right that's not I just I mean okay emotions wide okay TJ some parts of the ocean's a little Stranger than other parts all right all right yeah you know yeah I mean I'm not like opposed to it I just was all of a sudden I I blinked and you were like saying anime Chan where we went from index node to animation out get out weaves it's a strange strange place to be that's a solid block of code what are we doing here let's look at the Matrix opponent by the way with all that code and the fact that the top of this article says six minute read tells me one thing that Nate nobody reading that anime code time to scroll oh yeah request uh that's a solid block of code what are we doing here let's look at the major components I didn't look at any of these components but you get the idea we we get all of this okay no I haven't been to anime Chan but you get the idea okay we do a little bit of this we do a little bit of that get some of that and then we have a main that simply exports this uh and do that okay good corresponding node code get swappy Starship what axios anime title all right uh ID fetch rust fetch act uh axios test rust test okay okay there we go look at that you familiar with any of that everything looks okay so they're trying they're just trying it with two different ones they're like let's fetch some cool let's fetch some stuff with Russ let's fetch some stuff with axios and see which one is good is that what they just did well they also put a start and stop on each one and I think they're saying they're timing it they're timing it which is this is not a very great time the timing thing there's just just a few requests but okay yep and the results are this I know again if anything has ever said micro benchmarks can manipulate it can make any point ever this would this is truly the greatest micro benchmarks can make any point ever argument is this not just like it's not most of the time just waiting for an HTTP response yeah you can see it's a little bit faster did you see that okay guys they're gonna say this isn't worth it for this case true agree but the speed is definitely not worth it well because there is no speed this is amazing this is made up there's nothing here okay run it again and it'll be a different result anyways there is uh this difference is much more visible in CPU heavy tasks where Russ is inherently in lean in nature and ability to leverage multiple threads shine even more let's try a few more rejections can I just say something yeah for like if if you're writing an article this is just like a piece of advice personally and your first example is saying it doesn't make a difference I would recommend not having that be your first example I just like I'm not trying to dunk on the article I'm just saying like in terms of providing a compelling article that would make you want to finish and not just finish because we want to publish this to YouTube and so that people click like And subscribe on the prime time agent uh and maybe don't TV yeah oh dhtv is also a good Channel yeah um but that's just kind of it's just kind of weird right like you should there's these other ones are probably actually going to be a big difference so why would you pick the one that's not a big difference yeah I think what you'd want to say here is look at this what's the difference between these two pieces of code well as you can see there they look they look identical pretty much right yeah so I like that I can write the other part in Russ like that part's cool like I would have just shown how to use it I think instead of trying to like compare the performance that seems better right and I also would have probably provided uh maybe similar apis so they look identical so you can be like oh yeah like look at that they're the same thing underneath the hood it is true that it's cool that you can just basically be like hey these look exactly the same you'd never know that this inner part's in Rust that part's cool yeah that part's really really cool but uh don't ever compare Network requests to some service you don't control yeah right like that's just it's just it's not it's just not a thing you want to do because it's just always will look bad all right let's uh create a similar package as we did above but let's see they're gonna add reg X's which I'm I'm a little offended by right now I just want you to know like they really made this article for you what if we request anime quotes and compare the performance and then next up we do unlicensed regex comparisons it's like they knew everything that's gonna trigger me and put it all into one article they did it they did it um all right anyway so we have all this fun stuff a bunch of oh look at that a little Huckleberry Finn going on in there okay uh let's see read the string so apparently a bunch of reading to Strings going on here I'm not exactly sure but there there must be a bunch of bunch of stuff all right so process this regex okay there we go uh let's see measure okay so I guess we're doing a measuring going on right here as well a little Aztecs f64 okay also add this regex crate okay so we're gonna be doing some sort of measure uh you know regex pattern going on okay makes sense they're just going to compare how fast the regex's are I'm assuming and like Russ should probably be fast I'm assuming yep and they have a bunch of stuff in here by the way G in uh the G command inside of JavaScript is not necessarily doing what you think it's doing it's it's kind of it's kind of wild it's a stateful command so what you get out will actually it'll actually flop back and forth It's really it's not JavaScript really said like let's make our regex's stateful what that was like Patrick's is immutable and staple but if we did that hey man it's a push down automata of course it's stateful everybody knows that it's just like why would you do this to us so anyways they're gonna go through they're gonna do all this one uh so apparently they grabbed a bunch of timings none of this should be surprising at all um so blah blah blah blah blah right fantastic improved ratio right no time like I don't know if again I don't think you can really some of them are worse yeah some of them apparently are worse which it just again just shows me that you're paying tax on things you don't understand right like why is this rust one that much worse my guess is because what's really truly happening is that this thing's matching a bunch of times and because this thing's matching a bunch of times and node is lazy you're getting you're getting the results in this very lazy way versus maybe the other one's not lazy and so you're only getting one result from node versus X results from rust I don't know right that's like the weirdest regex too something that starts with a through Q and then but doesn't not U through Z for the 13 of those and then an X yeah so just just so I saw this is starting with a through Q and then 13 more things as long as they don't contain u through Z am I correct on that yes anything that's not U through Z and then an X well that's one it's a pretty common one for me so I probably will stick with the node.js regex engine I think that's a pretty common kind of thing that I'm searching for in my books your books are beautiful that's a pretty interesting result card the performance ranges from 0.14 X to 19.76 x with an average of 6.1 Improvement also the 14 out of 17 regex's show uh is it I thought the plural of regex's was regrets hmm it's reverts it's regards no regards uh show better performance on Rust compared to node regert's engine uh an interesting thing can I just say again like they said like an average like they ran a test Suite that represents like normative regex running over projects they're like well you have a suite of regex that we've you know custom picked from you know millions of regex examples but they're like they said it like 6.1 X like you can probably expect on average to have a 6.1 X Improvement for the rust regex crate again micro benchmarks what does that mean what do you what what agenda do you want to prove I'll make you one for the just that right like it just it's like they could have just picked a bunch more with whatever the weird thing that made it slow for the a through Q one and then but like frost is seven times slower than JavaScript node.j has proven to be 10x faster than blazingly fast rust yeah oh that's actually a really good idea for a YouTube video JavaScript is seven times faster than rust and then just like go through this and be like look at this look at that look at this and then end with no you're stupid that's not how it works right I feel like that's a good one I feel like there's something good there I don't know maybe I'll make that yeah I like it up or going to pi digits baby let's do something a bit more implementation agnostic and try to calculate the nth digits on Pi for example the benchmarks game the algorithm used in the variant of sequential spigot algorithm speak it's the little tourney thing right that you get water on and off yeah okay I don't know this algorithm uh we will be using a rug crate okay oh rug for for working with because all the crypto stuff's made in Rust these days or what maybe I don't know if they would have just chosen Zig they could have just done an i-72 and just got it done with you know what I mean yeah true by the way that is by far the weirdest thing about Zig it's just like well what size the ends do you have all of them oh you want a 167 fine by me go for it 160. that happened yeah just like I'm gonna make that happen why all right so here's some Rust code they're just doing calculating Pi we don't need to try to understand this again six minute average on read up top I don't believe this uh and the rapper for running the rust coded node okay looks good find pi 10 000 boom boom boom uh all right let's see here's the node code okay do all that crap and then we run it so I can tell you some things right away that are incorrect about this uh so there you go node massively slower so one thing that's very unique about node is for it to be able to uh optimize itself it depends on how many characters are inside of a function so since this thing has well a lot of characters and it's not minified which white space makes a difference you're gonna have this whole issue going on where it probably will need like 17 20 times to be ran before it actually does the jit optimization which means that you're running it once and taking the value so it's kind of a slightly unfair I didn't know node was white space sensitive that's that's news it's not known it's V8 if well V8 was white space sensitive I assume it still is white space sensitive right like it's well it's also just not how like like it's it doesn't just run something one time and then think now it's time to optimize right is that not oh no because jitting is a really expensive operation because compiling is really expensive so you wouldn't want to just jit everything you see because weapon if you get different arguments every time so they have to keep track of the type of arguments that's why node uses so much memory and it's not node it's actually V8 because they keep track of well it's also known but they just keep track of so much stuff to optimize every single function possible because if it's monomorphic they need to figure that out after X amount of calls and then they go okay this thing's monomorphic I can optimize it blah blah blah and so yeah you just jit your pants a lot of people jit their pants especially as they get older it's totally normal it is yeah that's an 18x Improvement not too bad yeah I I mean I would ensued assume interpreted JavaScript is by far the slowest possible thing out there uh you can also see some of V8 stuff so if you're curious about this there's a trace flag you can pass into node that will print out V8 tracings and you can also do it with like that Chrome it's not Chrome inspect I forget what it is but there's like the performance there's some performance Tabby thing yeah it's not in the inspect one it's like a separate place you can go uh profetto yeah and you can go and look at the Perfecto stuff and you can actually enable tracing on V8 and V8 will tell you a bunch of stuff it will also tell you why it is and isn't optimizing and so at some point I have to go break down why one of our libraries wasn't running fast and it's just like well look at this it it only optimizes after like the 9000th call because this function is 400 lines long like yes just don't do that just make it just just make it smaller let's see how we use the buttons at metlow these bindings make it possible to have a core library with battle tested code while still having uh Native performance this enables to support multiple Frameworks more or less out of the box with configuration requirements I mean this is cool I like this yes this is good agreed yeah fast if I all that all right I'm not gonna read this uh sorry or congratulations but how do you feel about this whole thing what's your takeaway from this TJ well what I wish like they I I'd be interested I guess like the main thing is actually neon not really mellow for this which is fine like I would have liked to see how does like rust enums how do those get taken from rust go into JavaScript because like though the reason that I would want to write rust for it is that I have probably some performance critical part or some part that is like really complicated that I would like to solve like rust type system to help me solve right that we have some sort of part of our application where it's like oh we always do this and then get that okay we've been doing it okay so we know that it needs to go fast now can how can we make it fast but also still not have to delete every single line of JavaScript we've ever written even though obviously that would be the best course of action best course um so I just don't that's the part that's like interesting to me especially for someone who actually has a real company that's doing things right not like oh I have a fun side project and I was the only one who did it and it was fun okay cool cool cool cool but like what does it look like if you're real so I don't know so that's kind of where for me like those were the things I was interested in seeing more about yeah not anime Chan anime didn't happen yeah I think the price I I always think that the performance angle as like the primary selling point it's like only if there's a huge negative right like so if calling the rust code results in 100x worse performance but you want to use it because it is 100x nicer to use yeah as far as like the the enums I bet you I could just answer that anything returned from this API has to fall into a JavaScript value and since JavaScript doesn't have type discriminated values you have to create your own type discriminators so you'd have to probably return it as an object with like type my type and then you value do something with it afterwards yeah so you just create your own wrapper that's all you have to do yeah yeah the only like I would do this if I had some part that was like really memory intensive too I guess because you could really like cut down a lot on your memory usage if there was a lot of like you have one struct and you need to do like a lot of stuff with it and then you get out one struck you could totally imagine doing that part in Rust and then and then dealing with it there that part would be cool yeah but yeah yeah so that's ex that's actually precisely why I was looking into this it's because it's just like well I keep having four gigabytes of of memory how do I stop having four gigabytes of memory my current answer is actually I import the V8 garbage collector and then I manually manage memory by setting everything to null oh nice that's pretty much JavaScript yeah yeah so after every line I have these functions called drain that will drain an array in reverse and then and then null it out and then uh what's it called and then uh call garbage collection just to keep my memory down so I got it down to so let's like it went from like two gigabytes to 200 megabytes and so I'm like all right rock on this is great but it's also literally 10 15 seconds slower because I'm just like garbage collecting not just started collecting dude it's just the worst it's just the worst and then the worst part is because it's on it's on a server I have to make you have to pay this expense and node where you actually have to create a bunch of workers to run your code because if you didn't every time a garbage collects all the things would stop stop it's not like you just get big pause you can just big pauses for everything so it's just it just it's just impossible impossible anyways all right I'd use this I'd use neon I think yeah I think um I've actually I think the use case of having a really easy story of writing like JavaScript or some other like more scripty style language and then having parts of your application being in Rust but it's like uh you know it's not no one has to know that it's in Rust they just call it like regular JavaScript functions is really nice I've been doing this for some neovim stuff where I write like a lot of um stuff that like talks to the database or like makes graphql requests or all these other things has to handle what kind of things we get back from graduate I write all that in Rust and then I have a shared library or like inner process communication and then I do all the just like boring scripty mutability of state of like the editor stuff for any of him all in Lua and it works really nice because you know that it's actually going to give you the data that you expect from rust and then I don't care about type safety for like which window is getting opened I just like make sure that that seems pretty good like that's a nice combo yeah but that's exactly what a scripting language is good at which is I don't want to have to think about anything this is why I use scripting language right I don't wanna I I agree is your Windows ID 0 perfect current window make it happen yeah right exactly you don't have to think about anything what is current windows for a while the global messages that I've received from this thing okay well cool just do it like yeah oh I have to make static const I need to wait I need a lot oh my goodness now I'm going to send this over here it's not send I got to make sure that my yeah actually I don't care let's just have some tables and some lists and we'll call we'll call it good get your arch Arc mutacy out of here yeah uh all right well hey oh there's definitely there's definitely a good meme somewhere in there with rust Arc and uh uh oh my goodness now I can't a mutalisk definitely some sort of mutilisk going on in here you could have some sort of mutalisk and have an arc mutilist I feel like this would definitely there's there's definitely something 30 people who will get that joke on Twitter it's gonna really kill this is it's a great joke okay this is a great pretty good for a joke that you made up instead of stealing from my Twitter still get oh man you like doubled my tweet it hurts oh I didn't just double it I I crushed you all right I know all right hey thank you for oh they're calling it a boomer joke that's not a boomer joke the name this is the boom origin the boom origin