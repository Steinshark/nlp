Welcome to the first episode of Issues Insights, interesting issues out there, from Github even to your favorite mailing lists - we'll We expect to produce at least one episode as we dive into today's issue from Valve rm rf-ing or recursively force deleting someone's Steam for Linux has changed a lot since 2015, you first install steam, after which you can run the binary file called "steam" found in the directory /usr/bin to start the client. This binary does not contain the full steam application but invokes files in the installation directory Before getting too deep, let's take a high level is the root directory, which as we know contains Then, we see that /usr/bin contains user programs contains programs essential for the operating The home directory, abbreviated as a ~ expect and is where each user stores all their In each user's home is the steam root directory It also has an important script called steam.sh, configure and launch steam. After setting everything up, this script will All of three of these entry points can technically different purposes and with certain limitations. Anyways, on January 14, 2015, Keyvin opened stating the following: &gt;I moved the steam folder to a drive mounted &gt;directory to the new location. Symlinks or symbolic links are just special that they are linked to. These are kind of like shortcuts, except symlinks layer as the operating system automatically So you can kind of see what Keyvin was trying with better performance or storage capacity, still find that folder using the original &gt;Then I launched Steam. &gt;It did not launch. &gt;It offered to let me browse and still could &gt;Steam crashed. &gt;I restarted it. &gt;It re-installed itself and everything looked &gt;Until I looked and saw that steam had apparently &gt;from the root directory. &gt;Including my 3tb external drive I back everything Doofy then follows up with a reply, having &gt;This is terrible. &gt;I just lost my home directory. &gt;All I did was start steam.sh with the STEAM_DEBUG If you recall, steam.sh is the helper script After a bit of digging in this script, they contents of the steam root directory. I think we're all familiar with what the One line above this command was the comment Soon enough, TcM1911 chimed in with a hypothesis: returned an empty string, causing the rm -rf Taking a closer look at STEAMROOT, this enclosing where the output of the commands run inside assigned to STEAMROOT. What is the output? Well it's going to be what is echoed or directory signified by this PWD environment The working directory of a script is where If you execute a script from the /tmp directory, be /tmp regardless of where the script is So the strategy here is to change directory then print the working directory. We have another OS provided environment variable being executed. Then, this percent signifies you want to remove pre-ceding string. The pattern here is a forward slash, followed So from the preceding string which is the and delete the first slash we see, followed In this case, we delete the name of the file, But this appears to work. What causes it to return an empty string? You see, if any part of this command fails will output nothing and therefore nothing Rcxdude notes that the command definitely directly with bash like so. Why is this the case? Normally, when you run a script in Linux by that it is an interpreter script, since it starts Then, it will invoke the interpreter with This first argument is what the environment However, bash and similar shells allow you into the command as long as it's in the This will start a new bash shell and run the which results in a dollar zero variable that Here is the phenomenon in action: we run the prints a file name, not a valid path. This causes the directory change command to root as an empty string, causing rm -rf to At this point, most were satisfied, and began the code was, and wondering how it was possible But wait, this recursive deletion is in reset_steam(), reset_steam() is only invoked under two circumstances. First, the user can intentionally pass the Given the bug report did not mention the reset All of these conditions need to be met, as Only one of them is important, the rest is ones out of the way first. Initial launch just verifies there isn't Next, current status must not be set to this ensure this doesn't get stuck in an infinite Next, this steam starting file must exist, folder has remained untouched, which would Lastly, it confirms that the steam script So the key condition which triggers reset_steam() variable has to be an empty string, the default Before the reset_steam check, steam.sh should this variable to 1 after installing some bootstrap The developers intended for reset_steam() to something went wrong. However in this case, nothing was wrong with that is based on STEAMROOT, which we've an empty string due to the other bug. So steam.sh fails to run the main executable environment variable is not exported if-statement are met, and then reset_steam() is called. So now we know how to trigger the bug: run This explains what happened to Doofy, who into Keyvin's original account, who only mentioned Well, a valve employee had a hypothesis: Keyvin being made for Windows doesn't play nice the executable bit in the version of Ubuntu This causes the steam binary to inevitably Then, he gets really annoyed and runs "bash amnesia and forgets he ever ran such a command. Keyvin replies that he only ran steam normally, and was the culprit, which makes sense given from Furthermore, he recalls he may have mounted of all files, which is reasonable given that mount NTFS drives in this way. And of course he is still very calm and collected. However, the exact play-by-play actions cannot its configurations was wiped. So what now? I suppose all we can do is guess, as I have how this happened: So it all started on a stormy Wednesday evening, and heads to the computer room to work on After setting everything up, he attempts to But steam fails to run. Not because the NTFS drive did not add the the symlink incorrectly in home/local, rather supposed to be. This is a fairly easy typo to make, as he He realizes his mistake, and fixes the symlink, While steam is still starting up, he absent-mindedly because why not, and forgets that he ever But unbeknownst to him, he actually accidentally In a stunning race condition, he manages to steam.sh is invoked but before the assignment no longer exists, the directory change fails, And we've already established that if STEAMROOT To fix the bug, various alterations to the dirname can guarantee a valid path is returned, is a real path. Furthermore, bash has built in options which so when the directory change or STEAMEXE execution of proceeding with buggy behavior. These are what ended up being the actual fix, Some suggested to write all scripts in a real typical Linux directories, lookup files from not writing untreated amateur hour don't use the wildcard, you just don't delete user data, by the way here is my public Valve has no idea how to linux, has this problem It's still happening. Question mark? You know, we could talk for centuries about don't need to achieve perfection. Anyways, it's been like 8 years and the guy, but he didn't provide further evidence See you in the next issue of issues insights.