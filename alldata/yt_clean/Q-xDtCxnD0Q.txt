Hey guys, many thanks for tuning in. Here's the or fast forward. You can use the video chapters about DNS filtering. And - guys - we will not so or adguard home - there's many videos about is rather how to integrate in their traffic for DNS filtering. We're going to But first - why would we want to filter this - the first one is removing or at So comfort and privacy really. And the How does that all work? When we browse to a the browser would first query a DNS server (DNS is what IP address speedtest.net has. It's kind of You know the name and the city of the person you and then dial it. DNS does pretty much the same address, it can then make an http or https request Inside that document there are usually many such as text or pictures. But - at the use case - there are also commercial ad with every single element in that page, Not only does this take time and hence slow down a totally ad-overloaded page. But that's not stored in your browser and can be used to track let's say the web site of a hotel or airline, when I later browse to another site I would then If we don't want that to happen then of sites that we want to filter - those We could filter the traffic coming from those throw it away - or we use a clever approach are using. That is - whenever a browser does a DNS don't give back the real IP address of that site such as the localhost address 127.0.0.1. The ads, trackers etc. would either not be delivered spots in the web page. The advantage of request the content and then throw it away but In the lights of the second use case - parental list. That means that if someone browses to (I don't know if that site actually exists) and see if the domain is in there. If it is, give back the IP address of a different site safe-search-engine.com. Again I just made them up for the sake of explanation. So we do know a lot of stuff already. We use whitelisting for parental control or that we Cool - how can we implement such a solution to show you four different ways how you can filter other DNS filtering application. Each of these and implications. Let's go through them. If you and 4. If you don't have OpenWrt or the like Just quickly before we do that we need to actually knows which DNS server it should use. Basically there are at least two ways we The first way is that we explicitly tell it to MacOS you can specify that on the properties of you can put in an IP address of a DNS server to or 1.1.1.1 if you prefer cloudflare or any The second method to tell your device which (that's usually your router) does not only but there are many other options in DHCP like my laptop or phone or tablet how to can set the domain name or - you have guessed On the client you would just set the DNS server to from the DHCP server and use the DNS server And that leads us to the first implementation Here's how things work in a home network without ISP and hence the internet on the WAN side. It your ISP. It also receives an announcement which On the LAN side, so inside your home, your router out either private IPv4 addresses - very popular IPV6 addresses. And it also usually tells all not only as the default gateway to the So typically clients would go to that router - the then forward that request to the DNS server This is our first option for We would use DHCP to tell the client that it but rather a third machine - and that Home server. Once we do this, a client would then request would go to that third machine here and or directly to a DNS Server in the If we have control over the router with a firmware RouterOS then we can modify that setting for the to the LAN interface, then the DHCP tab, Advanced add a field with option number 6 comma and then I know it's option number 6 ? Well, first it's googled for DHCP options. That yields many results Once I click on save and apply then would get that information and if its actually use it. The IP address that I put in here or a container running adguard But what if I don't have OpenWrt or the like stock firmware? Some router firmwares actually options. Let's check for example the TP-Link see that I can put in a primary and secondary DNS And what if my router firmware does not allow case I would use a separate DHCP server. but it doesn't have to. It could like a container or VM or another router. the internet gateway, your main router, Whenever a DHCP client is switched on it would server here? I have a DHCP Request - I want an IP switched that functionality off. The dhcp server I'm here - I have a DHCP offer for you - do you accept and the dhcp server would acknowledge and Alongside with the corresponding options. It's going to be 192.168.0.123 - and If you need to renew that lease then If you don't need it any more then please by the way - here's your default gateway which is the PiHole or adguard over here which has the IP On most routers you can switch Like here again in the TP-Link firmware I can In this old D-Link firmware I would go to Network Of course I would now need a separate DHCP Server want to use static IP addresses. Again container - like here in my example I have an LXC the isc-dhcp software package - that's a simple This container can now act as a DHCP Server and tell all clients that the default gateway but that the DNS server is our PiHole or Adguard You could of yourse run the DHCP Server on Cool - so we have seen that we may use separate device such as a Raspberry Pi or an In order to use this we don't really need consumer grade routers running stock firmware. in turn specify the router's address to be used as especially when your primary concern is parental the suggested DNS server. A client could still it probably depends on the children's age. ad filtering. Because in this use case you are offering real value by freeing Before we move on, we have a short CALL TO I'd love to hear from you if you are using or blocking web traffic in any way. Please do how long it took you to make it happen, how with the results. Also I'd love to hear from you adguard or something totally different ? Please Awesome - I promised you a couple of solutions. So We had seen in the chapter before that what the it forwards the request to the ISP's DNS server. The idea is that we now tell the router to forward rather than to the ISP's DNS. A client would hence router in turn would forward that request to the This can again be done without In the TP-Link firmware I would go to Network-WAN and tick the box "Use these DNS servers" and again On the D-Link firmware this option can be reached And again here you can input a DNS server address. DNS. Put the IP address of your PiHole or Adguard / Adguard, we would then however need to specify as the upstream DNS because if we told it to go The limitations of this solution are essentially that there is no real enforcement Furthermore this solution has one big your DNS filtering application you would not be All requests would rather come from the is that the router itself would use Cool. So now we have seen two options redirect DNS traffic with a clear focus on If your main concern is enforcement or preventing For this solution we do either need control over router that can do net filtering. In one of the to actually redirect IP traffic to a little enforce stuff with stock firmware for example. But the built in linux firewall in order to forcefully if the user had explicitely specified another any other DNS Server. DNS requests from inside adguard.From a networking perspective we can or TCP traffic that goes to a well known port So all we have to do is redirect traffic going the Pi or container that is filtering DNS. What from any device in the lan and wants to go 8.8.8.8 or any other DNS server - that this which is a Pi Hole or adguard Server. The router as a DNS upstream and should be allowed In order to implement this, we will use The tricky part is that we have two exceptions. The router itself is one exception to query DNS from the internet normally. PiHole / adguard machine because it should For this we need some help. The basic iptables option to distinguish between a local ip address context means the address of any interface on the outside the router. For this we need the software the addrtype module which in turn can distinguish of course install that module in LuCI under and then click on install or on the command Unfortunately there is no possibility to add We need the custom firewall rules here and type is iptables in the nat table - we append a rule before anything else and we do want to exclude triggers when the mac address of the source making address and also it only triggers when the address the rule will not trigger for the router itself In all other cases we do a Destination NAT and if need would be relay the filtered forward it to the internet. This way local In a nutshell this is really only one single line here. BUT - we need the iptables extra module addrtype option. Actually we need two lines - the rule we need to restart the firewall service. on "Restart" next to the firewall service or in an restart. You will find the rule in the Let's see if this works. In my have a client machine which in turn uses are also two DNS filter containers. One is home. The firewall rule redirects to I open a command line and do an nslookup list. And - surprise - I can see that the not accept the response. It says that the but it comes from somewhere That behavior is actually expected and basically a adguard server is in the same network and In order to remediate we can do two PiHole into a separate network so that it has or we force it to go through the router by you this. I open a shell on the adguard server, I goes through the gateway but everything on the by typing ip route del and then the destination Yep, now the nslookup works and Even if I try another DNS server go around it. I would need to use a VPN On the router itself in turn If I ssh into the router and do the error message at the bottom just means The IPv4 address resolves normally. If I lookup Now let's see if ad filtering is working. I go filtering by clicking on the Disable protection tab and refresh - all ad free for the moment, but here. Let me deactivate it. Refresh and as you can the rules in adguard - but I just need to clear nasty tracker cookies - and refresh the browser trying to load more stuff but just can't because same time - privacy plug in such as privacy badger Amazing. We have seen that we can use the router's firewall to actually forcefully redirect This use case is perfect for parental control to make sure that all DNS requests are Last but not least let me show you a fourth using at home. My kids are both of legal Furthermore I have a very powerful and disk so I can actually run adguard home to daisy chain first adguard which will and then dnsmasq behind which would then As DNS answers requests on Port 53, we need to port. By default, the native DNS server which is start. So I moved dnsmasq to a different port Oh - when you do this - please make sure that you not its dns name - because we will be fiddling connection. Also - dnsmasq acts as the DHCP server on your PC while you do this rather than a DHCP important here. If you move dnsmasq to a different then the router would not find the Adguard home is available as a software and install the adguardhome package. At the moment however adguard home can't First let me quickly show the output of netstat here. Now let's move over to LuCI. In I need to go to Network - DHCP and DNS - then we have the DNS server port field which I port that's not used by anything else. Once I in order to see the listening port Now let me connect to the adguardhome web I work through the wizard. I set and the dns to port 53 of course. That's the Do not set the web interface to Otherwise you will not be able to get into Specify a user and pass and we are good to running. It comes up normally because port 53 was the processes listening on these ports. We can see Next I need to tell adguard home where of course the localhost IP address and under settings - DNS settings where I type When a DNS request comes in to the router then be daisy chained to dnsmasq running then in turn forward it to the ISPs DNS if then I could of course add a modified version this time I would redirect to the localhost and also I would not have to Let me check if it is working. Quick nslookup the request shows up here. Just something that run AdguardHome on your router. AdguardHome on the /tmp filesystem. And there is no control In other words- if you have a lot of and can actually cause your router to stop Awesome - but let's stop here - this is already a so then a thumbs up is much appreciated. Please do and don't forget to subscribe - stay