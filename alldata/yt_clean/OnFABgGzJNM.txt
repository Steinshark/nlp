[Music] hey everyone charles judd here from kevin wallace training and in this video we're going to take a look at some ways that we can influence bgp path selection bgp is a topic found in encore anarchy and ccie so it's a very prevalent and important topic for our studies let's jump in now and take a look there are some special cases where we may need to override certain bgp default behaviors and we're going to look at some of the ways that we can do that in this first topology we're using a couple of routers r1 in autonomous system 65 100 and r2 and autonomous system 65 200. they're connected over a 10.1.1.0 24 network and they're advertising their respective loopback addresses that we can see here on the topology loopback 1.1.1.1 for router 1 and loopback 2.2.2.2 for router 2. let's first look at using the local-a-s command this allows bgp sessions to be established using an alternate autonomous system number than the one under which the bgp process is running this is helpful in cases where maybe you have a couple of corporate entities or maybe there are isps and they're merging together and you need an autonomous system to appear as though it's running under an alternate number that's a method we can use to migrate sites together so in our case on r1 we're already running under bgp process 65 100 and let's suppose that we want to merge this with autonomous system number 100. we're going to change our local bgp process on this router to as100 but we're going to configure bgp to still appear at 65 100 to router 2. and that way we can bring our bgp peering back up with router 2 without having to touch any of the configuration on the remote router tube here so let's start on r1 and say show run type 2 section bgp just to see what we currently have in place and you can see our existing process number bgp 65 100 our autonomous system so let's go under global configuration mode and let's take that out let's say no router bgp 65 100. we're going to see our neighbor adjacency with router 2 go down so that's expected so now let's put a new process in place we'll say router bgp autonomous system number 100 and now we can point to our neighbor by saying neighbor the ip address of router 2 is 10.1.1.2 that is in remote as65200 pretty standard configuration nothing new here but when i hit enter we're going to start getting some error messages and that's because on router 2 our neighbor command that's pointing to router 1 actually has remote as65 100 so it's expecting us to be in that autonomous system even though we're in as100 now that's why we're getting those error messages so we can make ourselves appear as an alternate asn than the bgp process 100 we're running under we do that by saying neighbor again 10.1.1.2 and now we want to use the local dash a s keyword and that's going to let us indicate a local autonomous system number for that router so we're going to say 65 100 which was our original autonomous system number and we'll give that just a moment and now you see we have a neighbor adjacency it tells us that we are back in the upstate so even though we're not running bgp asn 65 100 on this router we're running under process 100 it still appears as though we are to router 2. so now let's also go ahead and advertise our loopback address back out by saying network 1.1.1.0 we'll put our mask in 255.255.255.0 we'll end and we'll again say show run pipe to section bgp and you'll notice that now we're running of course router bgp autonomous system 100 we have our neighbor and the remote autonomous system 65 200 but here is where we indicated that to this neighbor we want to appear as autonomous system 65 100. so let's jump over to router 2 and let's say show ipbgp and we see our advertised loopback prefix from router 1 just as we would expect to see we see the next hop is router 1 10.1.1.1 and notice at the end that now we have two autonomous system numbers associated with this as100 and as65100 and we read this from right to left so this tells us that this prefix of course originated in as100 which we're running under then it went to as65100 before it came to our local as of 65 200. so that's how we would use that local dash a s command now if we want to hide this particular as we can add a couple of optional keywords onto that command let's go back to router 1 we'll go back under router bgp 100 and let's arrow up to get back to our neighbor command so there is our neighbor with the local as of 65 100 and let's add the keyword no hyphen prepend and replace hyphen as this is going to stop our prefix advertisements from informing the router about our actual bgp process that's running on the router so let's hit enter there and let's jump back to router two you'll see that we had a reset happen so our neighbor adjacency is back up now on router two so let's go here again and say show ip bgp so we again see our 1.1.1.0 prefix coming from router 1 the next hop but this time we only see the local as that we indicated we don't see as100 we only see the one that we indicated as the local as we have successfully stopped that asn from being advertised out to the router to pier let's now look at the allow a option so let's say we have a topology as we see here we have three routers we have r1 and r3 both in autonomous system 65-100 and we have r2 and 65-200 so let's suppose that the as65 100 routers are from the same customer but they're in two different locations so we have two different locations two different networks using the same autonomous system number what's going to happen is a bgp loop prevention mechanism is going to check for incoming prefixes and make sure that they're not originating from the same autonomous system number that the local router is in so essentially what's going to happen is the advertised prefix from r3 are not going to appear on r1 because of this because it's going to know that it's in its own autonomous system number we can override that with the allow as dash in command and specifically allow those prefixes to come in i already have a bgp neighbor adjacency between all of the routers and again they're advertising their loopback addresses r1 being 1.1.1.1 r2 at 2.2.2.2 and r3 at 3.3.3.3 let's start on r2 and let's say show ipbgp and we can see that we're able to see both the 1.1.1.0 prefix and the 3.3.3.0 prefix as we would expect to see both coming from autonomous system 65 100. if we go to r1 and do the same thing say show ipbgp notice we do not see the 3.3.3.0 network from router 3. and that's because that prefix is arriving from the same autonomous system number that we're currently in so if you have a situation like this we can run a very simple command to correct that on router one let's go under global configuration mode and our local bgp router bgp 65 100 and let's say neighbor 10.1.1.2 and we want to say allow a s dash in that's the keyword that we want to use and this is going to allow the route to now be installed in the bgp table so let's break out of here and let's again run show ipbgp this time notice we do see the 3.3.3.0 network we see that it first comes from 65 100 and then it goes to router 2 as 65 200 before arriving here locally on this router we can of course also do the same thing on router 3 to make sure we're not getting a similar situation on that side let's now look at the a s path pre-pinned option we have the following topology containing four autonomous system numbers you can see in autonomous system 1000 we're connected out to the internet and that happens from r1 which we have two paths we can go through autonomous system number 200 or autonomous system number 300 routers 2 and 3 respectively we want r1 to prefer the path through as200 and we can do that with the as prepend command remember the as path attribute which we can see in the output of our show ipbgp command and that's a well-known mandatory attribute so it's present for all exchanged prefixes between bgp peers that's used for loop prevention by pre-pending or adding an autonomous system number to the traffic path we can artificially make a route appear longer than it actually is which is going to influence our bgp path selection let's see how this is done first on our internet router let's say show ipbgp 1.1.1.0 24. that is the loopback address for r1 and that prefix is being advertised through bgp now you can see here we actually have two paths available it tells us right here and we see one through 3.3.3.3 which is router 3 and we see that's listed as the best path currently we also see a path through 2.2.2.2 which is of course router 2. we can also see this if we say show ip bgp where we can see the 1.1.1.0 network and we see there are two paths listed for that the best path is indicated by this greater than sign you can see up here in our status codes that tells us this is the best route and that route starts in autonomous system 100 which is router 1 and then goes through autonomous system 300 which is router 3. again r3 is listed as the best path so let's use the as path prepend option to influence bgp to prefer the as200 route over route 2. so let's first go to router 1 we'll go under global configuration mode and we're first going to create a prefix list and this prefix list is going to permit all of our prefix advertisements so let's say iprefix hyphen list i'm going to call this as100 we have a loopback network being advertised which is 1.1.1.0 24. so let's say permit actually i need to put my permit statement first i put that in backwards almost so permit 1.1.1.0 24. so we have that very simple iprefix list now let's create a couple of route maps one of those is going to have the pre-pinned option and one will not have the pre-pinned option so first let's say route hyphen map and we'll name the first one as100 we'll hit enter to go under route map configuration mode and we'll say match ip address and we want to match that to a prefix list which is as100 hit enter there we'll back up a step back into global configuration mode and we'll create another route map called as100 i'll call this one prepend and i'm again going to match the ip address for a prefix list as100 this time though we're going to prepend our own autonomous system number onto this route map so that we can influence our path and make this path look longer than it actually is so let's say let's hit enter first and we'll say set as hyphen path and we want to say prepend and then we'll indicate if we look at contextual help we can indicate our autonomous system number so we're just going to put our own autonomous system number we're going to prepend that there and if we look at contextual help we can continue to put those in there i'm going to add that on there twice a second time so i'm going to say set as path pre-pinned 100 100 and i'll hit enter now we can exit back to global configuration mode and we want to assign these route maps to our neighbors since we want to influence our path to take as200 let's apply the route map with the as pre-pinned option to neighbor r3 in as300 so let's go under router bgp 100 we'll hit enter and we'll use a neighbor command we'll say neighbor 20.1.1.2 and we'll say route hyphen map followed by the name of our route map which is as100 and again we want to use the one with the prepend option attached to that and of course we want to finally indicate our direction which we want to be outbound now we can do the same thing for neighbor r2 and as200 so let's say neighbor 10.1.1.2 route hyphen map this time we'll use our as100 route map again in the outbound let's jump back over to our internet router which is in as1000 and this is our again our internet transit router so let's look at our bgp table let's say show ip bgp and you'll notice right here was our original output remember our best path was indicated as starting in as100 and then going to as300 now our best path has indeed changed thanks to our pre-pinned option now the best path is seen as going from 100 to 200 so in other words going from router 1 to router 2 and then out to the internet we can see our prepended as numbers here our as100 that we added on to there twice to artificially make that path seem longer so this is exactly what we want to see we've artificially influenced our path to seem that the shortest path is through as200 so that's a look at several options we have for influencing our bgp path selection