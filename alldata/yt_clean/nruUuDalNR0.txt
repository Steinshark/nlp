One of the first things you must is to obtain and analyse the firmware. If you're lucky, you can download it from you can just get all the files from there. But what if none of these options are available? In this video, we will show you different and how you can connect directly to a memory chip Let's get started! Hey this is Pedro from the Flashback Team. Let's start by looking at a router board. We like to demo using routers because can be purchased by anyone and they contain a lot In the picture we have three things highlighted. We have the MCU, the SPI and the Flash Memory. The MCU is the micro controller unit. This is effectively a CPU in a package with This MCU is a Realtek chip, as you can see Why don't you go online and This package does not contain a lot of It will be stored in our Flash Memory chip. Upon boot, the MCU will communicate with the Flash Memory in order to get the How does this happen? Well that's the magic of the SPI This is a high speed, full duplex bus that allows Don't worry, we'll go into more details later. Let's briefly talk about flash memory types. On the left hand side, we have the one It is shown in a SOIC8 package, Package is just a fancy name In the middle we got the NAND flash, Here is shown in a TSOP48 package but again And lastly on the right hand This is a flash type that has very high and here it comes in a Ball Grid Array (BGA) There's a fourth type of memory used in and is slowly replacing eMMC. It's called UFS. Your computer BIOS is most Go ahead, open it up and have a look. But don't brick it! NAND would typically be used in larger devices, such as high-end routers, smart TVs, Whereas eMMC would be used in high-end devices. This would be more expensive stuff such as We will not go into NAND versus eMMC discussions. Just bear in mind that NAND is accessed so it requires a bit more tricks let's say. Whereas the eMMC is a NAND Yeah, I know it sounds a bit complicated. If you want to know more, we might release come to our training, where we explain all Let's talk a bit about NOR flash. It's a storage medium for non-volatile data. will remain in the chip until it is rewritten. reboot your computer, reset the Data can be read or written This is actually a key feature of NOR flash. For example with NAND flash you You have to read the size of which varies per chip, but is usually 4096 bytes. This means you have a lot more flexibility Another key property of NOR flash when is that it's mostly error free. What this means is that it does not require in the chip to work properly, and Additionally it has a very low directly from the flash memory, which As we said previously, this means that devices that do not require a lot of storage So how do we look at a NOR flash Well they usually look like this as They usually come in a SOIC package although The flash chip usually has a This is true not only for NOR but also for NAND. What you do is you read that model number, either things we like to do is take a high resolution And then you go on the Internet In this case MX25L6406E. If you're lucky, your datasheet will pop on your sheet, understand how the NOR flash model works But sometimes the datasheet is not available. In this case you don't need to worry much, as we and as long as you guess where the power is and you're usually OK, and Radek will show us how. Let's talk about the SPI protocol then. The SPI protocol allows for in full duplex mode using a This mumbo jumbo means that which controls the communication and and where the data is written to or The master provides a clock signal which will Multiple slaves can be connected to one Finally, and not less important, SPI requires SCLK: this is the clock signal we just mentioned. CS: Chip Select, think of it like an enable MOSI: Master Out Slave In. As the name data from the master, the output from the master. MISO: Master In Slave Out. This is where OK, I know this is all very abstract, The good news is that Mr. Radek right now and show exactly how This is Raaaaddddeeeekkk... All the content we put on our YouTube channel, that's all free and sponsored by... Our own training! Do you enjoy watching our videos, and finding and exploiting vulnerabilities? Then why don't you come to our embedded device hacking course, which we regularly host There are many hardware and embedded device but ours is truly unique. Why is that Rado? We focus only on REAL vulnerabilities And as you can see from our videos, real devices in Pwn2Own and for our day jobs. The goal of the course is to teach you how to take obtaining the firmware, reverse engineer Our mottos are: NO FAKE VULNS and PoC || GTFO! For more details check our Get your ticket now! That is a lot of theory... This is our target. We can see the main CPU and some The flash contains all the information Firmware, configuration and so on. It has to read it at the boot time. Can you sniff it? Let's try. For this we would need some cables and the logic analyser With hooks we can connect But in this case I prefer the clip, it's After that I connected the logic analyser Channel 0 to Chip Select, Channel 1 to SO data line, channel 2 to clock The logic analyser will allow Let's hit that power button and This is the software that comes with Saleae. I set the device to capture data Make sure you use the original high or you might not always OK let's start capturing. Wow we see some data! This is literally the router You're sniffing on the bus, how awesome is that! Let's have a closer look and see OK this looks very interesting and promising. We can see some waves changing but they are connected physically. Chip Select, Master In Slave This software has an amazing feature: we can add That means it will try to interpret the data. We assign the channels according everything everything else stays as default. And there we go! It interpreted the waves but For that we have to dig into the datasheet and We are sniffing on four pins of the flash. Pedro explained earlier in the video what So we know that the flash will SPI implements a set of commands. When it receives data, it matches and and interprets the following data accordingly. In our case we check the command It has an action of: &quot;n&quot; bytes OK let's try to understand it better. This is the sequence diagram for the READ command. On top the communication is started by By default it idles high. Next the clock dictates the Each clock cycle is 1 bit and then 8 bits are sent on the SI line, which But it is followed by 3 bytes of data. Those 3 bytes say from which And after this command, data should until the CS line goes back to high. OK let's see if that is what we Yes! Notice it's exactly as We can see the data being returned. So does it mean we can sniff firmware like this? Well I would advise not to do The data read by the router might not be complete or some I would always advise to But how do we do that? We need a microcontroller that is Ladies and gentlemen, let me introduce to you one It's an open source device that It's like a Swiss army knife tool. You just check the breakout diagram and wire Notice it has two channels for SPI. There are other tools out there that you could Bus Pirate, but this one here is much faster, implements more protocols and I can extend OK let's see how we could use the hydrabus What do we need: a clip, the hydrabus Now we have to match the pins on the I will be using SPI2 now as it supports serprog So I have to simply match each of the lines on the I'll be providing 3.3 volt power to the target, OK everything wired, we are ready to and we can use a magic tool flashrom is a standard tool It has tons of hardware supported so you Oh so it says it recognised more possible Let's help it as we are we were able Wow it dumps it! OK is binwalk going to recognise it? Yes that's the file system Sometimes flashrom might have chip and you might have to lower the clock speed. You can easily do that with the spispeed command. OK so it's a true Hackerman job. But what happens if flashrom You can cry in a corner or speak and I will show you now how to For this we need the hydrabus. We can connect to the hydrabus via serial console. It welcomes us with a nice menu. We select SPI in here, we have tons of things Not everything is in scope of this video I use the SPI1 device now as this is where OK let's have a look at the datasheet. One of the very nice command to send is READ ID. Each chip has a hardcoded ID and if We already know how to interpret this diagram. We have to pull the CS line down, send 0x9F In the hydrabus, we can do it very easily. The pull the CS line down, then we send the command OK let's try it. Yes it returned data! And yes this is valid READ ID data, as it And this is how it looks on So what else can we do? Let's send the READ command and It is 0x3, and as you want to read from the beginning, Yeah data is returned! So is this the way to dump the firmware? Well I think that would be quite Yes Radek we can script it. But guess what, I have You just need to go to the to the contrib directory and you will see there's Give it a try and you see it works quite well. You can use it to dump any standard SPI chip. And then, once that's done, it's We win!