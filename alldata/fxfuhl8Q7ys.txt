in this episode of nuke for noobs we're gonna start looking at the fun stuff cg compositing this video will probably be split into two parts because there's quite a lot to cover so i'll just record the whole thing and see how far we get okay so this is what we're gonna be making today i downloaded this car model and put some basic textures on it and what i plan to cover is going through all of the steps that are involved in compositing this into the shot so we're going to start off with the footage we're going to look at adding a couple of layers of shadow and then compositing the car on top we're going to look at some multi-pass compositing splitting out some of the channels and grading them individually and then putting them back in the mainstream also using cryptomats to isolate certain areas of the render using the depth path to do some 3d defocusing briefly touching on the lens distortion setup and then adding a few fancy bits at the end like some glow and some flares on the headlights so now i'm going to jump into a blank nuke script and start doing this all again from scratch also for anybody that's interested both the nuke script in this video and the blender file will be available in the one dollar tier on my patreon so if you'd like to get the file download it yourself change some of the textures or whatever in blender you can make some changes put it on a background you've shot and re-render it yourself and i'll also be providing the actual nuke script so that you can download it and see how i've done it so anyway first step is we're going to bring in our footage into nuke you probably know how to do that already but if you don't hit r on the node graph that will open the file browser and then you can jump to wherever the footage is saved this is what my footage looks like i'll also be providing this for anyone that can't shoot their own or doesn't want to it's a little bit blown out there is actually range in there so it's not clipping but i'm going to grade it down slightly just to make it a bit less overexposed to do that i'm going to hit g to add a grade node and just drop the gain down slightly until we have a bit more detail in the background buildings and the floor isn't quite so overexposed something like that looks pretty good before and after next thing i'm going to do is bring in all of the 3d renders so again hit r to bring up the file browser go into my renders folder so we've got the car beauty is the first one then the utility for the car and then also the shadow render i'm going to do the shadows first and let's work back to front so this is what the shadow render looks like it's currently all black but that's because the shadow information is in the alpha channel so if you press a on the keyboard that will show the alpha channel or you can do it up here there's two ways you can use the shadow pass you can just merge this over the footage so you can't really see it at the moment but if i use a merge node and put this over the top of the footage like this you can see that's what the shadow pass actually looks like there's not a right or wrong way to do it but i don't usually work like this i usually use the alpha to actually grade the floor down on the footage but before we do that we have to put our lens distortion on the cg because as you can see at the moment the shadow isn't in the right place it's going too far off to the side of the screen i rendered the cg with five percent overscan so it's 105 percent of the scale of the background footage which is just hd so what you have to do to apply lens distortion first of all is scale the render down so it's the same size as the background footage to do that you add a reformat node within the reformat settings you change the resize type to none and as you can see the car got a bit bigger there if i undo it and do it again you can see that happening again the pixels that it scaled up outside of the frame are currently being cropped off but we can get them back by turning on the preserve bounding box button over here and as you can see now we have this dashed outline on the frame and this is the extra pixels or overscan that we have on our render that go beyond the 1080p region the reason you need the overscan for this is because when we apply the lens distortion it drags these pixels inwards and if you don't have any information there you'll end up with black edges or missing edges on your actual cg render there's a few different ways to calculate the lens distortion i actually profiled my lenses on a lens grid which looks like this and if you have the chance to use a lens grid i would highly recommend it because this is the most accurate way to calculate lens distortion lens grids are absolutely enormous they're about 12 feet long about four feet wide so it's pretty unlikely that many people are going to have this so i'm not going to use this in this video another way you can calculate lens distortion is by drawing onto the footage and telling nuke where all of the straight lines should be most of you will probably be using a fairly up-to-date version of nuke and the new lens distortion node in nuke is a little bit funny i haven't really figured out how to get it to work with the overscan it seems to crop it and there's no setting to stop it from doing that so i used the old legacy lens distortion node the way to get back older versions of nodes in nuke is to press x and it will bring up this box and then you just type in the name of the node it's case sensitive so make sure you type it exactly like this just type lens distortion capital l capital d no spaces and then it will bring in the old lens distortion node here plug this into your footage and look at it and then what we're going to do is go along the top to this tab called line analysis we're going to turn on drawing on mode and this will allow us to draw some lines onto the footage to calculate the lens distortion manually the way it works is you click to add loader points like this and you basically just go along a straight line in your shot and add a load of points and then when you get to the end you right click and that will create a line this probably won't be perfectly straight because in the real world you don't really get straight lines everything's a bit bendy because it's all man-made so this won't be quite scientifically accurate but you can just do your best i'm gonna do one on here one on the edge of the building here it's good to do horizontal and vertical lines if you're clicking and you put one in the wrong spot like over here you can either do delete last point or you can actually click and drag the points once you've added them like this so you can drag it back into the correct spot okay that looks pretty good so now what i'm going to do is press analyze lines and as you can see if i turn that on and off now it's changed the lens distortion on the shot slightly it's not super dramatic i shot this on a 50 millimeter lens but that will do so what i'm gonna do now is disconnect this lens distortion node from the footage bring it over here to my cg plug it in under the cg at the moment it's trying to undistort the cg what we want to do is do the opposite of that and actually apply the lens distortion onto our render to do that come to the lens distortion main tab and then come down to this checkbox here called undistort we're going to turn that off and now it's doing the inverse so instead of undistorting it it's actually applying the lens distortion once you've done that you can also add a crop node because there's no need to have all of this extra overscan anymore we don't need that information and adding the crop will help nuke process everything a bit faster so this is our lens distortion setup now i'm going to add a backdrop onto this and i'm just going to name it rd for redistort you don't have to do this this is just an organizational thing but i do find it quite helpful because you can click and drag the backdrop and copy and paste the whole thing onto our shadow like this so now if i look at the shadow render you can see that this is in the correct place whereas before it was over here what i'm going to do now is get rid of the merge node because i don't like to work like that i'm going to press c which adds a color correct node plug this into the footage and then grab the mask input on the side which is this triangle and click and drag and connect it to the shadow render now if i look at the color correct node and i turn down the gain you can see that it makes the floor darker which is what we want i like to do a combination of dropping the contrast and also turning down the gain so for the aries and shadow it's kind of a fake way of removing all the specular highlights from the world around it i'm going to leave that about there for now we'll come back to that and fine tweak it once we've got the car on top and we can see what it's doing a bit better the next step is to put the car on top so i'm going to use a merge node by pressing m connect the b input to our footage and the shadow and then connect the a input to the cg it's probably worth making a bit more space here because we're going to be doing quite a lot with this render in nuke when you hold down control it creates a yellow dot in between two nodes and if you click and drag that dot it will create a point that you can then use to make everything a bit neater so you don't have any crazy diagonal lines the first thing i always do with cg renders is apply the copy pre-mult setup the first thing you want to do is add an unpremolt node onto the render this is going to expand the edges slightly as you can see then i'm going to add a pre-mult node which will undo what we've just done and put it back to normal and the idea with this is you start with the render then you unpre-mould it to make the edges a bit wider then you do all of your corrections and then you pre-mold it again which crops the edges back in if you don't do this and you start turning up the gain really high like this for example you might find you get some strange artifacts on the edges of your render if you start to push it really far the idea with the pre-molten unpre-mould setup is that whatever you do it will always retain the edges of the render and to ensure that the alpha stays consistent throughout the whole thing you want to also copy the alpha back in just before the premolt to do that add a copy node the shortcut for that is k drag and drop it just before the pre-mult and then what i like to do is press the full stop or the period key to add a dot and attach the a input to this and then drag it up and plug it into your render and just hold ctrl and click and drag to add another dot here to neaten it up so next we can start looking at doing some color correction this is what the car looks like on top of the footage currently with the lens distortion applied the first thing i always do is match the black and white points to the footage if i turn up the gamma in the viewport you can see the car has some much darker blacks than everything else in our background footage this will pretty much always be the case with cg renders they usually come out a bit crunchier than footage from a real camera it's really simple to fix that i'm going to press g to add a grade node and plug it in just before our copy node and i'm going to rename this to black points by coming over to the node tab and setting the label to black point and i'm going to make the text bold to be super fancy you always want this to be the last node before the copy so that anything you do before it you always have the black point set correctly by the end of the stream so now all i'm going to do is go back into the grades tab and just pull the black point up a little bit until the blacks of the cg start to match the blacks of the live-action footage you can reset the gamma in the viewer by pressing ctrl and clicking on the slider and if i select the grade node and press d you can see before and after it just lifts all the really dark areas up slightly and makes it match the surroundings better that's the basis of the color correction done already the next thing i'm going to do is use some kryptomats to get a bit more stuck into grading individual sections of the car to do that we want to use our utility render which is this one here it looks exactly the same as the car beauty but it has a load of different channels inside of it namely the kryptomat channels which are all of these crazy looking colors to access them and start creating the mats for the different sections of the car you want to add a cryptomat node and then inside the cryptomat node we have a few options the only one you really need to worry about is the layer selection this allows you to choose between different objects in the shot so in this we just have the car body and then the four wheels which are separate objects you can change it to crypto material which will allow you to select individual materials on the car so for example all the parts of the car that have a carbon fiber material in blender will all have the same color id and i can control and click on this to create a mat for it so let's clear the selection so i don't actually want to select the carbon fiber first the first thing i want to do a little bit of tweaking to is the color of the body to select the car paint hold ctrl and click and drag and it will select all of the areas that have the car paint shader applied if for some reason that doesn't work for you and it doesn't turn yellow make sure you have the picker ad box ticked and it will display the color picker inside of it if it's active you can also use pick a remove to get rid of stuff so for example i accidentally selected the headlights there and you can control and click and drag over anything to remove it like so so if i look at the alpha channel now by pressing a you can see that we have an alpha that's just the car paint material and i can use this to grade just the car paint without affecting anything else on the model to do this hit g to add a grade node and plug it into the main render then grab the mask input from off to the side and plug it into the cryptomat now i press a to leave the alpha channel and i look at the grade node if i start to change things in here you can see it's only going to change the car paint this is really handy for doing stuff like changing the color of the car making it brighter or darker obviously i'm going to take it one step further by only grading the specular parts of the render so i'm going to delete this grade node and what i want to do is shuffle out just the specular path which is all of the reflections to do this add a shuffle node plug it into the render i'm going to create a point just to make it a bit neater then for your input layer you want to click the drop down and select whatever channel you want to shuffle out in this case i'm going to use glossy direct the way this works is we're going to minus this from the beauty render then make some changes and plus it back on top you can do that quite simply with a couple of merge nodes so hit m to add a merge node plug it in under the unpremolt node and then plug the a input into the glossy direct shuffle node and you want to set the operation in this from over to from which is this one here now if i look at the merge node it's basically taking everything in this channel out of the main render so i turn it on and off you can see it's removing pretty much all the reflections then i'm going to add a second merge node by pressing m again plugging it in and again connecting the a input to the glossy direct shuffle hold ctrl and click and drag to neaten up a little bit and then you want to set the operation of this merge node to plus so we're basically taking it away here plusing it back on top there and if i disable them both you can see it's doing nothing because we're cancelling it out now the magic happens when you put something in between these two nodes we can change it before it gets plus back on top and then it will only grade that channel which is really handy so i'm going to look at the bottom here and i'm going to press g and just plug in a grade node in between these two and then if i crank up the gain it's going to make this all brighter i only want to do this on the car paint so i'm going to take the mask input from the node and plug it into the cryptomat node that we created a second ago and now we're going to use that alpha to only grade the car paint and i can turn this up and down to basically increase or decrease the reflections on the car you can kind of just do this to taste i'm going to look at it over the top of the footage and just kind of eyeball it the reflections look a little bit muted compared to the real world footage here so i'm going to crank them up a bit something like that looks better to me if i disable the grade node that's the before and after i also want to make the paint a bit redder it feels a bit washed out at the moment so i'm going to try and put a bit more of a punchy red into it and really i want to do that to everything except for the reflections so i just want to grade the color without affecting any of the highlights so to do that we can do it in between these two merge nodes so basically we can take away the reflections then change the color and then put the reflections back on top afterwards to maintain their color so i make a bit of space for myself here i'm going to press c to add a color correct node plug this in grab the mask input on the color correct node plug it into the cryptomat over here which make it a bit neater again and then if i look at this on its own you can see i can turn up things like the saturation and i can open the game controls and add a bit more red to take out some blue and i can make it a bit more of that classic sports car color and then on top of that we put the reflections back on and now you can see the color changes underneath the reflections without really affecting them so that's how it's looking now we've just made a few changes but it's already looking much better i think at this point it's probably worth saving it because otherwise you'll lose all of your progress that's probably already quite a lot of information so before the end of this video we're going to talk quickly about defocusing i specifically shot this with quite a shallow depth of field so you can see that the flowers and stuff in the background over here are a bit out of focus and the focal plane is about here in the foreground where you can see the tiles on the floor are nice and sharp in nuke we want to be able to apply the same depth of field onto our render so the back of the car is a bit out of focus and the foreground here is nice and sharp the first thing i do on top of any cg renders in nuke is pretty much always add a soften node if i plug this in you can see what it does it's pretty self-explanatory it just makes everything a little bit softer the default setting is a bit high i usually set it to something like 0.2 and this just takes a little bit of that really crisp 3d rendered look out of the render then the next step is to use the actual depth pass to do some 3d focusing the depth pass for the car looks like this this is the missed pass that's come out of blender and essentially it's a gradient that goes from the front to the back of the shot in this case the stuff that's darker is closer to the camera as it goes further back it gets lighter so every depth in the shot has its own color value basically and the computer can work out how far away stuff is and then with that information it can also work out how much to defocus it based on where you set the focal point the node for doing this in nuke is called a zd focus and if you search for it and plug it in here this is what it will do the way it works is you have a focal point and wherever you put this it will make it in focus and the rest of the shot will be out of focus you can visualize this a bit better by changing the output over here from result to focal plane setup and you can see wherever i move the focal point it's changing what section is in focus i turn up the depth of field slightly the green line will increase the green line is what's perfectly in focus the blue areas are what's in front of the focus area and the red areas are what is behind it like i said the shot has quite a shallow depth of field so i'm going to leave the depth of field fairly low something like that i'm going to look at the actual footage and work out where on the floor the focal point is it looks like it's about here so it'll probably be about here on the car i'd say let's maybe make it a little bit further back just for some artistic licensing get the headlight nice and in focus then if i set the output back to result we can see what that looks like it's obviously way too strong at the moment so you can turn down the size setting to something like one probably even less than that let's go point four and that will reduce how much defocusing is happening and then it's just a case of fine-tuning it really the edges are going a bit nut so i'm going to turn down the maximum to a below a number as well so that it's not going quite so crazy those settings look pretty good to me if i disable it and enable it you can see the back of the car is nicely defocusing and we're retaining the sharpness in the foreground here i think we'll leave it there for that video that's the real bread and butter of cg compositing matching the colors getting the black points and everything right and then matching the focus if i turn some of this stuff off you can see the before and after of what we've done in this video already it's already sitting really nicely into the shot there's gonna be a part two of this following very soon in that one we'll dive a bit more in depth about tweaking some of the colors making it look nicer and then doing some fun stuff like adding some flares and things onto the lights thanks for watching this video hope it was helpful and keep your eyes peeled for the next one very soon [Music]