all right let's do this faster compilation with the parallel front end in nightly okay so apparently maybe less parallel we were less parallel at one point with rust i don't know it looked very unparallel you know when you used to build it it would just like literally say the numbers and go one by one through it kind of looks like they did a topological sort and then never actually did a topological sort with groups if you don't know what a topological sword is you know next friday or next thursday free on twitch i want to be doing an 8 hour course that touches on topological sort anyways you should know this by now okay the rust compiler's front end can use parallel execution to significantly reduce compile times to try it run nightly compiler with the dasz threads 8 option this feature is currently experimental and we aim to ship it in stable compiler in 2024 keep reading to learn why par you got to learn why don't tell them don't tell them to skip rust okay don't tell them to skip this okay make them learn make them know show them expose them all right compile times and par parallelism rust compile times are a perennial concern really the compiler performance working group has continually improved compiler performance for several years for example in the first 10 months of 2023 there were mean reductions in compile time by of 13% in peak memory use of 15% and in binary size of 7% as measured by our performance suite okay that's i mean assuming that their performance suite is telling the truth you know i think would i mean i don't know how they measure but to me what seems to be a significantly better measurement is that they own crates.io they know a bunch about compiling they should have just literally used crates io we reduced our machine overhead by 15 machines at any one time or 21 machines out of 400 or whatever it is right like if they just did did that you would know exactly how much are you actually improving cuz i always have a worry about performance suites right performance suites because they're not real sometimes i just want to see the real deal just say how you affected crates.io and then we can all move on right it would make perfect sense however at this points the compiler has been heavily optimized and new improvements are hard to find there is no lwh hanging fruit remaining but there is one piece of large let's see but there is one piece of large but high hang fruit parallelism rust compiler or the current rust compiler user benefits from two kinds of parallelism the newly paralleled front end adds a third kind okay okay i'm getting excited i'm getting excited we're getting ready existing interprocess parallelism when you compile rust program cargo launches multiple rusty processes yes i've seen this cu my all my all my course go bye-by compiling multiple crates in parallel this works well try compiling a large rust program with j1 flag to disable paralyzation it will take a lot longer than normal so it'll take from it'll take from 5 minutes to 20 minutes got them all right you can visualize the parallelism if you build russ cargo's timing flags which produce a chart showing how the crates are compiled the following images show the timeline when building a rip grip on a machine with 28 virtual cores okay okay okay let's see we got a bunch of stuff going on right here fantastic and then we hit this really long definitely not in parallel anymore oh this must be a a bunch of like all the dependencies how did sde get way down here how did sde json get way down here how did sday and sday jason get down here it seems like sday should have been up here obviously duh there are 60 horizontal lines each one representing a distinct process their duration range from a fraction of a second to multiple seconds most of them are rust see and a let's see and the few orange ones are build scripts the first 20 processes all start at the same time the this is possible because there are no dependencies between the relevant crates but further down the graph parallel paral parallelism reduces as crate dependencies increase although the compiler can overlap compilation of dependent crates somewhat thanks to a feature called pipeline compilation oh cool there is much less parallel execution happening toward the end of compilation and this is typical for large rust programs interprocess parallelism is not enough to take full advantage of many cores for more speed we need more parallelism within more processes hell yeah hell yeah i hope you guys are getting excited i'm getting excited for whatever whatever this is let's do this okay so they do obviously do a topological sort and execute things as parallel as possible so that i mean that should not be surprising all right existing interprocess parallelism the back end the compiler is split into two abs the front end and the back and the front end does many things including parsing type checking and borrow checking until this week it could not be parallel execution okay interesting because i know borrow checking is like a huge is definitely slow i know linking and borrow checking are like the two big slowdowns so if you could do like a parallel typeing across your project could you potentially find problems before you have to do all the slower parts i don't know it's kind of an interesting concept what you can do in parallel right type checking all these things parsing why can't you just parse all the things in parallel i don't know i don't know the answers to these i have no idea how the compiler set up the backend performs code generation the it generates code in chunks called code gen units and the llvm processes these units in parallel this is a form of coar grain parallelism okay okay we can visualize the difference between serial front end and parallel back end following the images shown shows the output of the profiler called samply measures rust c as it does a release build of the final crate in cargo the image is superimposed with markers that indicate front end and back end okay front end back end okay i feel like we can see some problems here all right this does look this does i mean like that doesn't look good can we all agree that's not a w can we get fs in the chat maybe like an f two fs three fs five fs how many fs can we get in the chat have i five fs okay we got enough fs we got enough fs to move on forget you guys no you shut up okay don't you come in here dropping fs all right each horizontal line represents a thread the main thread is labeled russy and is shown at the bottom it is busy for most of the educu the other 16 threads are llvm threads called gp cgu z through cgu 15 there are 16 threads because 16 is the default number of coen units for a release build classic 16 for 16 you know what i mean there are several things worth noting front end takes 10.2 seconds back end takes 6. 2 seconds the llvm threads are running for 5.9 seconds of that the parallel code generation is highly effective imagine all those llvm executed one after another i can imagine i can see it i can feel it it's kind of like the front end even though there are 16 lvm threads at no point are all 16 executing at the same time despite this being run on a machine with 28 cores the peak is 14 or 15 this is because the main thread translates its internal code representation mirr to llvm's code representation llvm ir in serial this takes a brief period for each coen unit and explains the staircase shape on the left hand side okay okay the front end is entirely serial yeah yeah okay so it looks like we got a lot of w's going on here looks like we got a lot of potential for some dubs going on here this reminds me back in the day when rulia conquered the philistines and negotiated trade contracts at the same time thank you history buff i mean i i understand we have we have some history buffs going on here you know contract trade negotiation always very difficult you know people have been stuck on that i mean we're still stuck on that so congratulations that guy all right hold on just one second i go to i i want to pull up twitch chat so i can actually read it instead of reading it off my own feed right now i'm literally reading it off my own feed and that's really annoying i'd rather read it in a dedicated window all right let's pop this bad boy out let's pop it out i'm somewhat of a buffery of history myself yeah off your own feet yeah yeah all right here we go new inprocess parallelism the front end the front end is now capable of parallel execution it uses rayon to perform compilation tasks using fine grained parallelism okay okay many data structures are synchronized by mutus and read write locks atomic types are used where appropriate and many front end operations are made parallel in addition of parallelism was done by modifying a relatively small number of key points in the code the vast majority of the front end code did not need to be changed okay this better be amazing what we're seeing there we go that looks good this looks much much better i like what i'm seeing right here this is cool i like that whatever this samply is i never have seen samply but it has this nice little it it has this nice little what's it called like how much actually is being used kind of cool it's kind of weird that they all dip at the same time you know just interesting more than anything else so this does obviously reduce compilation by a huge percentage awesome when parallel front end is enabled and configured to use eight threads we get the following samply profile when compiling the same example before okay faster front end execution takes 5.9 seconds down from 10.2 backend takes 5.3 down from n 6. two nice and lvm threads are running 4.9 seconds of that down from 5.9 nice the additional seven let's see the seven additional threads labeled rusty operate in the front end they reduce front end times time shows that they are reasonably effective but the thread utilization is patchy within the eight threads all having periods of inactivity there's room for significant improvement i like hearing this okay this is actually pretty cool so here we'll skip that so how to use it we do this little bad boy okay okay so let's get nightly let's actually just try this out let's just try this out i like this idea all right so i'm going to go like this cargo clean right there we go rmrf let's just make sure okay target's gone fantastic so let's do ourselves a little bit of rust rust up a tool chain install nightly let's make sure we're on the the tippity top all right what version do we need does it say what version we need it says it's in nightly but like what what does that mean is there like a seven 1.7 something how do i know i have the right things oh well whatever we'll we'll see we should be able to see do do already work on resolved issue about memory leak there are some cool tools for memory leaks and all that valren is pretty great you also if you're if you're if you're doing just like javascript and you're looking for memory leaks you got yourself a little bit more of a goofy way you have to approach it which means that you're going to need to use like chrome dev tools and do heap snapshots i've accepted inevitably and the inevitable and swapped to neo good job all right there we go so now we're on the latest of the latest nightly 175 hopefully that is that is where we need to be and so what we're going to do is i'm going to go like this cargo build whoopsies release oh crap cargo clean time cargo build release let's just do a very simple test ourselves very simple obviously this is not real again crates io with thousands and thousands of buildings all the time would be fantastic all right there we go pretty great we're looking pretty good i think we're pretty happy about that little number right there so i'm just going to copy it i'm going to do a cargo clean oopsies cargo clean apparently i cannot type today cargo clean and then let's do the let's do this thing right down here let's go down here and let's execute this bad boy i just want to see it i want to i want to feel it you know what i mean i want to feel that all right so what are we looking at 154 seconds of time overall but actually'.37% okay we had'.37% i i i don't think i must not have this version because that that should have obviously worked right that should have obviously worked here we'll just go to 16 you know when in doubt just add more threads that's what i always say that's what i always say well that's awkward yeah i know it is a little bit awkward blazingly fast is there a way to clean all of cargo's data is there a way to yeah okay that somehow that did not help me is there a cargo reset yeah that's not a real thing rmrf rout okay i could try that i could try that more threads equal slower yeah we actually got we actually well i don't know if that's actually true the problem about doing anything on your own system is like dude i have like twitch running i have youtube videos up we have like a lot of stuff going on can can't you just delete cargo does cargo which cargo see the problem is if i delete cargo i delete more than than just cargo f let's see find cargo max depth 2 what do we got in here we got a bunch of bin director so we definitely don't want to do that we have registry packages what do we use here to delete all these things cargo cash remove dur all okay cargo cash i don't think i have cargo cash do i oh remove remove dur all that's a lot of gigawatts i just got a lot of memory back okay there we go so now let's try this again we'll go back down to eight let's see how we do i did have to download just then see that was kind of unfair i had to do some downloading see the problem is is we had this little download phase see it's not it's not even fair it still looks low okay i don't think we're getting anything out of this okay we're not getting anything out of this we're not getting any obviously i must be missing something okay what lives are seven no the compiled compiled rust is huge okay compiled rust is giant my nightly isn't new enough yeah oh are you on the right version let's find out cargo version i'm on the latest nightly as of like i guess two days ago i'm on two days ago so i don't know if this is it anyways okay well we'll drop the whole trying it out thing all right all right hey couldn't get that to work apparently whatever i was doing did not seem to actually make it work so the name is i am excited about rust compiling faster because i do think that'd be a huge win but still the linking is very very slow i'd love to see some improvements in that whole area jen