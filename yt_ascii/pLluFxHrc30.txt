so we had some good feedback from the video on wannacryptor but, some questions about basically what it is, what it does, from an encryption point of view. and that, actually is a quite interesting topic because what it does is similar; obviously slightly different. but similar to what most of the other ransomware does, as well. so i thought we'd cover, pretty much sort of the basics of what it is that ransomware does beyond it just has a private key and encrypts your data. which is obviously, sort of, the assumption we'll perhaps start with a look at a really rubbish one that i'm making up as i go along and we'll kind of build it up into a system that kind of makes sense, and you'll see hopefully how it uses both symmetric and asymmetric or public key cryptography combined to try and produce an effective exploit. okay, so let's imagine that i wanted to write a piece of ransomware - which i don't,  i should add? i don't think people should be writing ransomware, but but knowing a bit about how it works is quite a good way of understanding a bit about how cryptography works. there's really two major types of cryptography that we see a lot of like symmetric encryption and asymmetric encryption [i] will put hash functions aside for one for one day so symmetric encryption quite simply have one key for encryption and the same key for decryption. all right? so a aes is a good example of an symmetric block cipher that people use a lot of at the moment. asymmetric encryption or public key cryptography is where we have a separate key for encryption and another key for decryption? and that has numerous benefits in some circumstances and drawbacks in other circumstances so what wannacryptor does is combine both of these things to try and get a solution that first of all will run offline, so if they're not connected to their command and control servers they can still encrypt your disk and theoretically decrypt it later  - although the jury's out whether they actually will bother. so let's imagine that we're writing to some  ransomeware, right? the first thing we could do is we could choose an symmetric encryption cipher like aes, right? we could say what we're going to use aes and to do that we need a symmetric key, so i could developer. i'm programming this up i could write a piece of code that searches through all the files on someone's hard disk and for files of a certain type i could replace that file with a copy of that file that's been passed through this cipher so i need to come up with a key so i generate the key. so let's call it ks for the symmetric key. the difficulty here is if i'm going to use this key to encrypt people's data. it needs to have access to it so either this needs to be sent to the malware as it's running in which case there's going to be a compromise that the the keys been sent over network hopefully people (researchers) could find it on the network, and then use it to decrypt someone's files without having to pay any money alternatively, it's a very naive approach you could just bury it inside the code. people do this a lot.  there are actual ransom wares that have done this it's not the best approach so you basically put this string ks somewhere in the code and then the ransomware is able to encrypt it and - when it wants to - decrypt the files. all right now obviously that's not a good solution because anyone disassembling this code - and researchers do this within minutes of code being released - will immediately find this string and then tell everyone: "oh look, the keys in this file" well, let's just decrypt it this way. and then write another tool which uses the same function and the same key so that's not a good solution. to improve on this slightly, we can bring asymmetric encryption in. so this is our first attempt i'm working my way towards something competent, so don't judge me yet. so in asymmetric encryption we have two keys:  we have a public key and a key private now, as long as the private key is kept secret then in some ways we can encrypt everyone's files with the public key and when they play the ransom give them the private key. that's kind of a general idea. so early  ransom ware worked this way. so when when the ransomware started it would generate a public and private key pair it would send the private key off to a server somewhere to hold it for ransom and then it would encrypt everything with the public key. this usually uses rsa there are other options? we won't talk about the mathematics of rsa except to say that it's being very very difficult to calculate this private key given only this one so if you're not watching this when it gets installed this private key is gone and all you can see is the public key, and then you're in a bit of trouble now there's a few downsides to this the first is that asymmetric encryption is quite slow right the mathematics involved in rsa is it's not too bad on a computer but we do it generally for smaller messages. if you were trying to include a lot of someone's files with this it would take quite a long time and also you have to have a connection to your commander control server if you're malware is running and let's say they're temporarily not on a wi-fi or something like this, then what happens is it tries to upload this private key? and it can't so one [of] two things happens, [then] either. it has to stop or it just encrypts everything with the public key and we lose the private key or the private key has to be temporarily stored on a disk which isn't going to work well for holding it for ransom, right? none of these solutions are very very good, so that isn't a very good solution either. it's a bit slow and there's an issue of trying to upload this to a command control server, and how we're going to do that so what modern ransomware does - and this is not exclusive to ransom where lots of encryption schemes work this way - is a hybrid encryption scheme where the majority of the encryption so the actual encryption of your files will be done with aes or some symmetric cipher and that key will be protected by public key cryptography, so you're holding [one] of these private keys for ransom and when you get it back you can then unencrypt ks and unencrypt the files that's the idea so this is what wannacryptor does. so wannacryptor, when it's off in a directory, it starts undertaking lots of different tasks. one of the tasks it does is start up threads for trying to spread itself using the eternal blue exploit but the majority of the work in terms of encryption is separate to that. and what it will do from inside its own executable it will extract a zip file which is also encrypted it would decrypt this using a password and then [it] will extract those files now they hold things like hard coded bitcoin addresses that we know about that you're supposed to be paying this ransome, hard coded public keys of the server (which i'll talk about in a moment) the addresses, the tor addresses of the server for the tor hidden services it extract all of these things and then it gets to work, encrypting your files so the first thing it does is it generates an rsa key pair. [if i start a new page, then then we won't be confused with my terminology that essentially i'm making up as we go along, so...] [did you solve that rubik's cube since we were here?] [i changed a couple of pieces around i haven't solved the rubics cube yet, i could but i like to annoy people with having it unsolved on the shelf it also takes me quite a long time] so okay, so when wannacryptor installs itself and it starts running it needs to generate some keys, that it's going to use to encrypt your files the first thing it does is generate a public and private key pair for this infection. and these are for the client all right? so let's call them c_pub and c_private it. so we've generated a public key and a private key right? now these are 2048bit rsa keys skipping over the math a little bit to try and calculate the private key if we didn't have it we would have to solve a very large integer factorization problem which is not happening, sufficed] to say. normally, what a ransom-ware would do now is, with this private key off to a command-and-control server, delete it so that we never get it back unless we pay a ransom and then encrypt everything with this public key. but in a hybrid encryption scheme we work slightly differently stored inside the executable is a server's public key, this is a command and control server so this that we have here is s_pub. now this public key has an associated private key but we have no idea what it is, right? it's stored somewhere on one [of] those command and control servers or all of those command and control servers and these were generated [when] the ransomware was created a while ago  [end of manually checked subtitles] so the client public and private keys are generated on the fly [for] every time it installs itself on anyone's machine the server's public key is stored inside the executable and it's always the same and it's associated with a service private key hidden somewhere else that we haven't got access [to] if only we did it's worth mentioning at this point that if we could find the server and get this private key that would be good news right we could decrypt everyone's around ransoms files perfect it's hidden on the dark web, [right] so the onion addresses that are supplied hard coded into one a krypter point to servers somewhere on the planet but we don't really know where right we will deal with hidden services on another video because i think it's a real interesting topic what the client then does what one equipped? er does it's got to try and protect this key so that it can hold it to ransom so what it does is it encrypts it with the server's public key so let's say it takes these down here and it produces [f] pub of c private like this is my strange notation [that]. i'm sort of making up. this is kind of [right] business so this is encryption right and we've encrypted this private key with the public key all right. so now it's totally useless it's completely mangled we can't use it remember that in rsa these perform the opposite tasks so for example if i had all my files encrypted with c pub i could decrypt them all again with c private right so that needs to [preserve] so the malware needs to stop me from getting to that file. which is done now by encrypting it we can't decrypt it again because we don't have the server's private key that's the issue here right, so then what happens is for all files the client will generate a f key which will call kf4 file right and encrypt the file with [kf] then so we're going to store in essence c pub of k f and k f okay, so let's look at what i've just written here each client has its own public and private key pair right now that's important because theoretically if one person paid the ransom and they said them let's say the shared private and public key pair, then everyone you seem to pay the ransom [one's] problems [going] away, right? that's not a foolproof solution. so what we do we generate an [okay]. we generate a kf aes key for every single file then we encrypt the file with that so let's just draw that in so it makes it makes it sense [kf] file, right so we encrypt the file with kf then we store that file on disk and we attach to it that key so that it can be undone but we hold it to ransom by encrypting it with our clients public key so let me run this which files are all in encrypted with a smash it key, so they're encrypted quickly [yep] but then that symmetric key is been encrypted with a brand new generated asymmetric key pair yeah, which is encrypted with the public-key, so that only the server can be tricked exactly right? so there's a kind of chain [of] decryption here that we would have to solve if we wanted to undo all this and get our files back would return us. just one file on the disk to get our file back we need to decrypt it with kf right, which is a symmetric key unfortunately kf has been encrypted with this public key here for the client so [we] need to work out what the private key for the client is unfortunately again the private key has been encrypted with the public key of the server so the only way we can find this private key is to ask the server for its private key or more likely ask the server to decrypt it for us and send it back so you can imagine a situation where you paid your ransom? like someone on the other end decided that was [ok] and you were going to have you're going to get your files back so to be clear you shouldn't pay the ransom because it encourages crime, and there's no guarantee they'll do this and in fact [we've] want to click - it looks like they're not really bothering right? i don't partly because there's a few implementation issues. it's not clear whose bitcoins you're paying - it should have had you should have had a so most ransomware will have a bitcoin assigned for your client, so when it generates these keys it will also generate a bitcoin address right so theoretically this is [all] automated [you] would pay the ransom and then theoretically they would choose to they look at that bitcoin address and go okay. yes. [someone's] paid [will] send them back the private key their private key not the case here right it seems to be kind of manual and in lock come is anyone's actually doing it but i can sympathize with [people] who have had their files encrypted [right]? it's one thing to say don't do it don't do it but you can imagine if you were in a [situation] where your family photos have been encrypted you might be quite desperate to get in the back so hypothetically [if] someone paid a ransom and it was going to give it [back] what would happen is the client would send off this encrypted private key right? which it doesn't know anymore? to the server and the server would decide okay? they're allowed their files back for whatever reason and would decrypt this with their private key so s proof right which i'll put in here s private spr. b. right so they decrypt our client private key with their server private key and send it back [over] the network like this is all happening tor by the way nothing going over the open network we then have this private key back again which we can use to decrypt our k f which we can use to decrypt our file and then it just iterates through all the files doing that process so you can see that the thing they're actually holding to ransom is the fact [that] we don't know this private key and they've encrypted our private key the benefit of this [approach] is you get the speed of aes? which over a bunch of files on a disk is unbelievably quick? somewhere around i think seven hundred megabits per second of encryption rate. i think on on a decent intel machine with aes instructions on it you get that benefit? but you also have the benefit that the private key but sort of the master key as it were it held only on the server and never needs to be sent to anyone and the only way to undo all of this encryption is to know what that is and the other bonus is but you don't have to be online to do any of this some man somewhere if it can't connect to the command and control server will immediately shut down which is nice of them i suppose because it means they're not going to encrypt your files if they know you can't get them back but this doesn't do anything like that this encrypts your files first ask questions of a server later so if the command and control [server] disappear there is no hope because this private key is gone. that's the idea surely at some point this aes key is in the clear because it's dead again yeah, and so is this private key right so at some point while it's running this private key will exist and before. it's encrypted it will be in memory now there's a few problems [with] first of all it's way too late for most people, right? but theoretically if antivirus [is] being vigilant that might help but but not really the other thing is that it's quite hard to access memory for other processes because of fairly good security measures in windows and [linux] and any other operating system but separate out processes from one another [so] really this is operating in its own address space it's quite hard for anything else to sort of get in there and quickly look at the keys and stick them in a file in that time period so really that isn't i don't think an avenue of research in terms of trying to fix this problem [much] better to do things like the web-based sinkhole that stopped it running completely and then keep a vigilant eye out for new variants show up. you know daily now is there any way of working out how [its] [generating] those keys and using that technique? if it was using a poor? encryption library right, then maybe there will be a weakness that you could use right as it is to generate these keys it's using the windows standard encryption library which is not bought. it's like. it's perfectly good [so] that's a that's going to be a problem the best bet at this stage of getting your files back is not paying a ransom it's hoping that someone will find this server the real location of it and extract this master key at that point everyone else [a] [tool] will be released within a day, but just does all this put it reverse process and solve the whole problem [this] has happened in the past to ransomware that's been brought down i believe cryptolocker for example was an early ransomware but when they finally brought down the server they also extracted the master key and [were] able to publish tools to undo everything [there's] no guarantee that will happen in this case right the dark web makes it quite hard to find these servers especially if for example the massive publicity surrounding this has caused them to essentially just do a runner [maybe] not even i mean i think the servers are still running but you know i don't know but what the end game for this is we don't know will they find the servers won't they will this just all to disappear and unfortunately some people have lost some files. we'll have to wait and see how doing backups yes? what was the best way to back up then okay? hang on [you] put me on the spot now so the best way to do backups is multi-location right so not a single hard disk because it might die but also not [to] hard disk sitting next to each other in case your house falls down and smashes [our] hard this cloud storage is very good because they have this [multi-site] that done as we built in if you don't mind giving your file to them and paying their costs right so some common i use some combination [of] cloud storage and hard disks and burning to blu-ray and things like this