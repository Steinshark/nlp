the cloud flare rex's catastrophe unraveling the web of chaos okay so i don't know what it is greetings adid here and today let's embark on a journey into the heart of cloud flair's july 2nd 2019 meltdown where a seemingly innocent rex rule sent shock waves through the internet brace yourself for a tale of code chaos and catastroph catastrophic consequences catastrophic catastrophe dude i'm such an idiot what a great intro and i fumbled the bag the guy literally wrote my intro for me and i fumbled the bag i fumbled the easiest bag of my lifetime i fumbled the bag harder than netflix did with the witcher i fumbled the bag harder than amazon prime did with rings of power i fumbled the bag harder than amazon prime did with wheel of time damn damn son damn son take two flip can you take it out flip can you can you take that previous part out greetings adida here and today let's embark on a journey into the heart of cloud flair's july 2nd 2019 meltdown where a seemingly innocent redj no redj are innocent rules send shock waves through the internet brace yourself for a tale of code chaos and cat cat [ __ ] catastro catastrophic consequences gosh dude dude i can't dude it's like saying compartmentalize i cannot compartmental compart com compartmentalize compartmentalize am i saying that right compartmentalize i don't even think i'm saying it correct i literally cannot say that word i cannot say that word it's impossible the prelude crafting the perfect storm of redexes in the realm of web security cloud flair's engineers work were hard at work refining their defenses against cross-site scripting attacks little did they know that a seemingly harmless redx rule would turn their world upside down cross scripting cross-site scripting the art of injecting malicious code into websites was the target i will like to say that you should never think a redx is innocent redes are like unless if you're doing like/ d5 it ain't like dude rexes are the devil's lettuce for sure absolutely regex sorry reg regex regex the weapon regex rules and their untold power cloud flare a global content delivery network relied on thousands of server strategically placed worldwide their web application firewall wff a wet ass firewall better get a mop and bucket for this one was the guardian armed with regex rules to sift through incoming quest regex the symbol-based language of pattern matching was their tool of catch malicious urls to catch malicious urls okay okay okay okay well should have used a different tool dog should have used pickle regex are great no sarcasm may the lord bless you in your various conquests using regex for i know that regex prowl prowl around like a lion seeking to devour whoever they can okay i just want to let you know i just want to let you know it's it's bi it's a biblical proportioned catastrophe waiting to happen the unseen threat a mischievous reject rule emerges o mischievous oh dog damn do oh damn dog an engineer to toiling away a cloud cloud flair's firewall team crafted a regex rule to to detect cross- side scripting attempts this rule aimed to catch javascript keywords spe suspicious characters and strings with equal signs a potential indicator of malicious url query strings the engineer submitted this rule unaware of the chaos that it would unleash dude why like honestly real talk if you just had javascript keywords why not string includes or contains depending on your language suspicious characters string contains string with an equal sign string contains that's such a bad design choice absolutely this it's seeming terrible the domino effect from poll request to global catastrophe the poll request was submitted triggering a sequence of events continuous integration ran test on team city giving a green light peers reviewed approved and merged the changes again i will say this that let's just say you have 50 lines changed and one of them just one of them is a regex for whatever reason when people read code they're like oh yeah okay yeah oh nit we got a knit oh okay okay what about this oh regex fine okay nobody knits a regex nobody knits a regex ever they just like when someone sees a it's almost like you just skip over it it's like doesn't even it it's like doesn't even dude i've seen so many people just lgmt dude oh my god when i see a reg x line i go blind exactly dude you get like the blinders go up and you're like i can't see it i can't it's not moving i'm a t-rex i can't see it it's crazy we will bike shed over looking at a regx literally 4-hour conversation on whether an a variable should have an underscore or not but nobody bats an i at a multi-line regx the domino effect from poll request to okay okay yeah okay the stage was set for global deployment however this was wasn't your typical roll out wet ass wet ass firewall that's what it is rules had a unique power instant global deployment without the usual phase approach nice within minutes the internet fell felt the tremors every cloudfire server worldwide started redlining at 100% cpu w failure surged and the impact was cat catastrophic up to 80% of customer traffic was dropped panic set in as declared a p0 incident esal dude i wish i knew what a p i when people just have these i don't know what p0 means in this case is this like a specific cloud flare thing it's a pz like if someone yelled p 0 priority zero is that like high or low it's just like defcon i don't know if defcon 5 or one is is is worse oh zero is the highest isn't that just like a is that not just a weird phrase we have just i just want to throw that out there that when someone's like priority one it's the highest priority you're like really seems kind of odd to me anyways escalating to every corner of the of cloud flare okay okay the emergency response race against time with millions of websites relying on cloud flare the urgency was palpable engineers delved into the chaos searching for the culprit it took a mere 20 minutes minutes to identify the wet ass firewall process as the root cause the decision was clear execute the global terminate shut down wff globally to restore nor normaly the outage was stemmed by the global terminant but a wet ass firewall remained disabled the team meticulously validated roll back back of the faulty rules and reenable the wet ass firewall globally after 40 minutes the lesson was crystal clear regex if misused could bring down the digital realm the real question lingered how did this redx rule wreak such havoc okay i want to see it let's see the rule the redx rule seemingly innocuous harbored a dark seeker man okay dude this is like can you just stop waxing philosophical and just get to the effing point okay this is enough foreplay stop forplay me tell me the gosh darn thing that happened here in let's see in reg the greedy nature of matching combined with back tracking on failure led to exponential computation the servers faced increasing request lengths the regx engine spiraled into performance abyss causing cpu usage to skyrocket okay can you give me like an example what what does that what do this exactly mean read the regx and d out i want to see the regx to prevent history from repeating itself cloudflare transitioned to regx engines guaranteeing linear runtime the switch to google 2's re2 a regx engine based on deterministic finite automa a dfa ured you know canadians i've often ran into call them automatas ensured that the matching time scaled linearly with input length saving cloud flare from future regex nightmares re2 great game it was a great game re2 was one of my favorite i beat that one that was one of the few i actually beat full st straight up okay hold on okay since this one doesn't give me the meat and give it to me raw what's this one i just want to see the effing regex like what was the effing regex all right do we h did i i just saw it i just saw it okay okay the cpu exhaustion was caused by a single wet ass firewall rule that contained a poorly written rex expression that ended up in creating excessive back tracing the regular expression was at the heart of it okay whole oh there's so many question marks oh there's so oh my goodness there's so many how the hell did anybody approve that like how did anybody look at that and go yeah that's pretty good is this a rex fork bomb because okay a question mark operator effectively means like what happen when when something is not matched with that does it like go back and rerun something with the next one like how does this actually go because in my head what happens here which again i'm not good enough at doing this right like i'm literally not good it looks good to me is that they would look for this it would fail go back to the beginning look for this fail go back to the beginning look look then it would do that all and then it would also use nan and then go back and go go through them all again and then go to here then go back and do it all again and go there rex calculator does anyone have a rex calculator that's not how it runs okay i literally have no idea i i i i i avoid regexes like the plague i genuinely only use them in extremely rare circumstances for the most benign stuff possible right what do i do here i i again i is there like a graph is there a graph is there a graph top right i i i i don't i don't know rexer you guys gotta you guys got to remember you got to give me the simple ones because oh that was the left okay fair non-capture group group multiple tokens together without creating a capture group non-capture group create multiple groups doing this non-capture group multiple tokens together doing this damn i the problem is i don't know what these i don't know what these c these capture groups do i don't know what non-capture groups do and why this is so evil dank memes dude looks good to me i it looks good to me dude i honestly have no effing clue rex per rex per one of these is going to be a porn site one of them i'm just going to go to and it's going to be like get big rexes now any character goes back in and goes through any character what is this line what is this line any character any character equals any character damn that's damn go damn damn son by the way just so everybody knows this is why you shouldn't use re this is why you shouldn't use reg x's okay because you're not good enough at using them okay just write an effing pains look at this do you realize how easy it is to go like this string includes this this this this this this this do you know how easy it is to write this right here like this isn't hard either to write you have these things index of this literally like literally index of this plus two equal sign and length is greater than plus two + one like that's that's not that's not a hard parser to write it takes like 3 seconds to write that at effing parser this is just a bunch of contains so stupid it's so stupid it's just so effing stupid there's a video on it can you get me to a spot that's like good cu i don't think we need to rewatch like an intro being like then so then on this on the on the olden days of byon y when this happened if this is effing if i get rick rolled it's a spike so the issue was with this last section here we have a non- capturing group signified by the question mark and colon which specifies something to match for but not include in the outputs now that we know what a non-capturing group does we can throw all that out the window since it's actually irrelevant here whether or not there's a non-capturing group the regx engine still needs to match the expression contained within so we can safely ignore it oh interesting yet a dot star non-capture group dotar not equal sign dotar huh huh we are already familiar with all of these characters splitting the expression into four parts the three dot star sts each match any number of any character and the equal sign matches for an equal sign but what does so that's like a is this like some n cubed operation going on here math ain't ma i'm not mathing right now the matching process actually look like intuitively it makes sense to start with the first symbol attempt to match and then go to the next one but how do we know how many characters to match if we match every character it becomes impossible for the equal sign to match anything and the answer is we don't know most hell yeah engines simply match as much as they can backtrack on this is so funny right here or you know you could have just used contain equal sign literally if you do look at this for a second anything equal sign anything you know what that does sound like that does sound like index of equal sign and or contain equal sign it's [ __ ] the same thing failure and match slightly less the next time repeating this until there is a bro really spent 13 minute video instead of just doing a contain dude i know match or all combinations are exhausted to elaborate when cloud flair's regex attempts to match this example string these are the steps which occur first this first dot star greedly matches all three characters next the second dot star greedly matches the remaining zero characters then the equal sign fails as the previous matchers took the equal sign already after this the algorithm backtracks the second do star matched nothing so there is nothing to backtrack however the first do star matched all three characters so we backtrack and see what happens when we match two then the second dot star can now match the remaining x but the equal sign still doesn't match anything we backtrack again this time matching zero characters with the second dot star and it doesn't work it's a great visualization here's the deal i use a lot of dot stars just want to throw that out there i use a lot of dot stars okay i don't use them in production code but i use them on the command line dotstar should be forbidden no it it's very very useful but that's wild i'm putting this in my twitter bio right now i can't believe this line destroyed cloud that getting that line defeated cloud flare this is incredible hold let's finish this out star matching only one character now the second dot star greedy takes the rest of the characters and the eagle sign is left with no match and we need to backt track again this cycle continues a few more times until it finally finds the match in 23 steps if the string matches one more x the number of steps increases to 33 then 45 which you may notice is not linear in fact as the string to match gets longer the increase in steps can potentially be exponential easily a no way oh snap oh my goodness anyways i think today's lesson today is don't don't do rega like just don't just don't okay if like i understand that there is the regx that is just literally like here where's the pickle here where's the where's the pickle one there we go like i we all understand that regex right like everybody gets this one i get it everybody gets this but that's never what you do in production it's never what you do in production that's the problem is almost all production regexes are crazy they're always crazy they're always crazy because because you know like anything that's you just you have to take it to the logical extremes for five numbers that seems fine yes i agree like if you literally are looking for a string that looks something like you know foo bar some set of numbers bass if you used a regx to just say end a set of numbers i'm not going to like i'm not going to complain about that i don't think it's great but whatever that that's fine with me i get that it's it's usually it's actually usually more clear and fine why does it have the escape character because dude because it's it's it's it's a string man strings you got to escape the slash to get a backlash you got to escape the slash to get an escape character so you have to double escape to get the single escape you know you know what i mean i know so yeah in production zip codes aren't five digits exactly in production this line becomes a disaster how big of it zip code regx a stack overflow the place where you should copy your reg x's anyone any anyone like this idea is a valid zip code four is not nice nice or how about these ones are they which one of those are correct i don't know i i i don't know like i don't i don't want that i don't want that my code base i don't want that in my code base okay you know what i want my code base something that i can parse with my eyeballs looks good to me that's that that doesn't even exist doesn't even exist okay anyways don't this is i'm regx blind dude i am regx honestly i regx blind write a damn function honestly at that point it's just so easy to write a function with a few if statements you know what i mean the future of ai code it literally is the oh my goodness ai were trained off stack overflow stack overflow uses reg is to solve everything oh no oh no